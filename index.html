<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>COPILOTO ‚Äî Assistente de Obje√ß√µes em Tempo Real</title>

<style>
  :root{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow: 0 10px 26px rgba(17,24,39,.08);
    --shadow2: 0 6px 16px rgba(17,24,39,.07);

    --primary:#4c5bd4;
    --primary2:#3f4bd0;
    --ring: rgba(76,91,212,.18);

    --good:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;

    --chip:#f3f4f6;
    --radius:14px;
    --radius2:18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 400px at 12% 0%, rgba(76,91,212,.10), transparent 55%),
      radial-gradient(900px 520px at 92% 12%, rgba(245,158,11,.09), transparent 55%),
      var(--bg);
  }

  header{
    position:sticky; top:0; z-index:5;
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 18px;
    max-width:1200px; margin:0 auto;
    gap:12px;
  }
  .brand{display:flex; flex-direction:column; gap:2px}
  .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
  .brand span{font-size:12px; color:var(--muted)}
  .statusline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px;
    border:1px solid var(--border);
    border-radius:999px;
    background:#fff;
    box-shadow: 0 1px 0 rgba(17,24,39,.02);
    font-size:12px;
    color:var(--muted);
  }
  .dot{width:8px; height:8px; border-radius:999px; background:#cbd5e1}
  .dot.on{background: var(--good)}
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:11px;
    padding:2px 6px;
    border:1px solid var(--border);
    border-bottom-color:#d1d5db;
    background:#fff;
    border-radius:8px;
    color:#374151;
  }

  main{max-width:1200px; margin:0 auto; padding:18px}
  .grid{
    display:grid;
    grid-template-columns: 300px 1fr 420px;
    gap:16px;
    align-items:start;
  }

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow: var(--shadow2);
    overflow:hidden;
  }
  .card .head{
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(229,231,235,.75);
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .card .body{padding:14px}
  .title{display:flex; flex-direction:column; gap:4px}
  .title h2,.title h3,.title h4{margin:0; font-weight:800; letter-spacing:.2px}
  .title h2,.title h3,.title h4{font-size:14px}
  .subtitle{margin:0; font-size:12px; color:var(--muted); line-height:1.35}

  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 9px;
    border-radius:999px;
    background:var(--chip);
    color:#111827;
    border:1px solid rgba(229,231,235,.9);
    font-size:12px;
    white-space:nowrap;
  }
  .chip.good{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.22); color:#065f46}
  .chip.warn{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); color:#7c2d12}
  .chip.bad{background: rgba(239,68,68,.11); border-color: rgba(239,68,68,.24); color:#7f1d1d}

  .updated-badge{
    display:none;
    align-items:center;
    gap:6px;
    padding:6px 9px;
    border-radius:999px;
    background: rgba(76,91,212,.10);
    border: 1px solid rgba(76,91,212,.22);
    color: #1f2a9a;
    font-size:12px;
    white-space:nowrap;
  }
  .updated-badge.show{display:inline-flex}

  .productName{font-size:16px; margin:0; line-height:1.2}
  .productMeta{padding:10px 14px 14px; display:flex; flex-direction:column; gap:10px}
  .infoList{margin:0; padding-left:18px}
  .infoList li{margin:6px 0; font-size:13px; line-height:1.35}
  .hint{font-size:12px; color:var(--muted); margin:0}

  .inputWrap{display:flex; flex-direction:column; gap:10px}
  textarea{
    width:100%;
    min-height:240px;
    resize:vertical;
    padding:14px 14px;
    font-size:14px;
    line-height:1.55;
    border-radius:12px;
    border:1px solid var(--border);
    outline:none;
    background:#fff;
    box-shadow: 0 1px 0 rgba(17,24,39,.03);
  }
  textarea:focus{
    border-color: rgba(76,91,212,.45);
    box-shadow: 0 0 0 4px var(--ring);
  }
  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
  }
  .btnRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

  button{
    border:1px solid rgba(229,231,235,.9);
    background:#fff;
    color:#111827;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    box-shadow: 0 2px 0 rgba(17,24,39,.03);
    transition: transform .06s ease, box-shadow .16s ease, border-color .16s ease;
    user-select:none;
  }
  button:hover{
    border-color: rgba(76,91,212,.30);
    box-shadow: 0 10px 20px rgba(17,24,39,.08);
  }
  button:active{transform: translateY(1px)}
  .primary{
    background: linear-gradient(180deg, var(--primary), var(--primary2));
    color:#fff;
    border:none;
  }
  .primary:hover{box-shadow: 0 12px 22px rgba(76,91,212,.20)}
  .danger{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.22);
    color:#7f1d1d;
  }
  .ghost{
    background: rgba(76,91,212,.07);
    border-color: rgba(76,91,212,.20);
    color:#1f2a9a;
  }

  .responsesGrid{display:flex; flex-direction:column; gap:12px}
  .responseCard .body{padding-top:12px; display:flex; flex-direction:column; gap:10px}
  .responseText{margin:0; font-size:14px; line-height:1.55; white-space:pre-wrap}
  .responseFooter{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}

  .fx{position:relative}
  .fxPulse{animation: pulseGlow 650ms ease-out 1}
  .fxSlideFade{animation: slideFadeIn 260ms ease-out 1}
  @keyframes slideFadeIn{from{opacity:.35; transform: translateY(6px)}to{opacity:1; transform: translateY(0)}}
  @keyframes pulseGlow{
    0%{box-shadow: 0 0 0 0 rgba(76,91,212,.00)}
    30%{box-shadow: 0 0 0 6px rgba(76,91,212,.18)}
    100%{box-shadow: 0 0 0 0 rgba(76,91,212,.00)}
  }
  .highlightBorder{border-color: rgba(76,91,212,.45) !important}

  .toast{
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 30;
    display:none;
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border-radius:14px;
    background: rgba(17,24,39,.92);
    color:#fff;
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
    max-width: min(440px, calc(100vw - 32px));
    font-size:13px;
  }
  .toast.show{display:flex}
  .toast .mini{width:10px; height:10px; border-radius:999px; background: var(--good)}

  .overlay{
    position:fixed; inset:0;
    background:rgba(17,24,39,.55);
    display:flex; align-items:center; justify-content:center;
    z-index:20;
    padding:16px;
  }
  .modal{
    width:min(560px, 100%);
    background: #fff;
    border:1px solid rgba(229,231,235,.9);
    border-radius: var(--radius2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modal .mHead{padding:18px 18px 0}
  .modal .mHead h1{margin:0; font-size:20px; letter-spacing:.3px}
  .modal .mHead h3{margin:8px 0 0; font-size:14px; color:var(--muted); font-weight:700}
  .modal .mBody{padding:14px 18px 18px; color:#374151; line-height:1.55; font-size:14px}
  .modal-actions{display:flex; justify-content:flex-end; gap:10px; padding:0 18px 18px; flex-wrap:wrap}

  .drawer{
    position:fixed; inset:0;
    display:none;
    z-index:25;
  }
  .drawer.show{display:block}
  .drawer .backdrop{
    position:absolute; inset:0;
    background:rgba(17,24,39,.55);
  }
  .drawer .panel{
    position:absolute;
    right:0; top:0; height:100%;
    width:min(720px, 100%);
    background:#fff;
    border-left:1px solid rgba(229,231,235,.95);
    box-shadow: -18px 0 40px rgba(0,0,0,.18);
    display:flex;
    flex-direction:column;
  }
  .panelHeader{
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(229,231,235,.85);
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .panelHeader h2{margin:0; font-size:14px; font-weight:900}
  .tabs{
    display:flex;
    gap:8px;
    padding:10px 14px;
    border-bottom:1px solid rgba(229,231,235,.85);
    flex-wrap:wrap;
  }
  .tabBtn{
    padding:8px 10px;
    border-radius:999px;
    font-size:12px;
  }
  .tabBtn.active{
    background: rgba(76,91,212,.12);
    border-color: rgba(76,91,212,.25);
    color:#1f2a9a;
  }
  .panelBody{
    padding:14px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .formGrid{display:grid; gap:10px}
  .formGrid.two{grid-template-columns: 1fr 1fr}
  .formGrid.three{grid-template-columns: 1fr 1fr 1fr}
  label{font-size:12px; color:var(--muted); font-weight:800}
  input[type="text"], input[type="password"], textarea.smallArea{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    outline:none;
    background:#fff;
    font-size:13px;
    line-height:1.4;
  }
  textarea.smallArea{min-height:92px; resize:vertical}
  input[type="text"]:focus, input[type="password"]:focus, textarea.smallArea:focus{
    border-color: rgba(76,91,212,.45);
    box-shadow: 0 0 0 4px var(--ring);
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .muted{color:var(--muted); font-size:12px; margin:0; line-height:1.35}
  .list{
    display:flex; flex-direction:column; gap:10px;
    border:1px dashed rgba(229,231,235,.95);
    border-radius:12px;
    padding:12px;
    background: rgba(243,244,246,.45);
  }
  .item{
    background:#fff;
    border:1px solid rgba(229,231,235,.95);
    border-radius:12px;
    padding:10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .item h5{margin:0; font-size:13px; font-weight:900}
  .item p{margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
  .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .miniBtn{padding:8px 10px; border-radius:10px; font-size:12px}

  .notice{
    background: rgba(245,158,11,.10);
    border:1px solid rgba(245,158,11,.25);
    border-radius:12px;
    padding:10px 12px;
    color:#7c2d12;
    font-size:12px;
    line-height:1.4;
  }
  .success{
    background: rgba(22,163,74,.10);
    border:1px solid rgba(22,163,74,.22);
    border-radius:12px;
    padding:10px 12px;
    color:#065f46;
    font-size:12px;
    line-height:1.4;
  }

  @media (max-width: 980px){
    .grid{grid-template-columns: 1fr; gap:14px}
    .area-product{order:1}
    .area-input{order:2}
    .area-resp{order:3}
    textarea{min-height:210px}
    .topbar{padding:12px 14px}
    .formGrid.two, .formGrid.three{grid-template-columns: 1fr}
  }
</style>
</head>

<body>

<!-- WELCOME -->
<div id="welcome" class="overlay" style="display:none">
  <div class="modal">
    <div class="mHead">
      <h1>COPILOTO</h1>
      <h3>Assistente de Obje√ß√µes em Tempo Real</h3>
    </div>
    <div class="mBody">
      Digite (ou dite) a fala do cliente. O sistema identifica <strong>produto</strong> e <strong>obje√ß√£o</strong> por palavras no texto
      e mostra 3 respostas (leve, m√©dia, agressiva).
      <br><br>
      <strong>Novo:</strong> a caixa de di√°logo limpa automaticamente ap√≥s processar, para manter leve e sempre atualizando.
    </div>
    <div class="modal-actions">
      <button onclick="closeWelcome()">Entendi</button>
      <button class="primary" onclick="closeWelcome()">Come√ßar</button>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginOverlay" class="overlay">
  <div class="modal">
    <div class="mHead">
      <h1>Entrar no COPILOTO</h1>
      <h3>Acesso controlado (Admin edita / Usu√°rios s√≥ usam)</h3>
    </div>
    <div class="mBody">
      <div class="formGrid two">
        <div>
          <label>Login</label>
          <input id="loginUser" type="text" placeholder="ex: edson" autocomplete="username" />
        </div>
        <div>
          <label>Senha</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:10px; justify-content:space-between">
        <label style="display:flex; align-items:center; gap:8px; font-weight:800; color:#374151">
          <input type="checkbox" id="rememberMe" />
          Lembrar neste dispositivo
        </label>
        <span class="chip">Admin: edson / 2026</span>
      </div>
      <div id="loginError" class="notice" style="display:none; margin-top:10px">
        Login ou senha inv√°lidos.
      </div>
    </div>
    <div class="modal-actions">
      <button class="primary" onclick="doLogin()">Entrar</button>
    </div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="brand">
      <h1>COPILOTO</h1>
      <span>Assistente de Obje√ß√µes em Tempo Real</span>
    </div>

    <div class="statusline">
      <div class="pill" title="Microfone manual (n√£o fica escutando infinito)">
        <span class="dot" id="micDot"></span>
        <span id="micLabel">Microfone: desligado</span>
      </div>

      <div class="pill" title="Sess√£o / acesso">
        <span id="rolePill">Acesso: ‚Äî</span>
      </div>

      <div class="pill" title="Atalho para limpar">
        <span class="kbd">Ctrl</span><span class="kbd">K</span>
        <span style="color:var(--muted)">Limpar</span>
      </div>

      <button id="adminBtn" class="ghost" style="display:none" onclick="openAdmin()">‚öôÔ∏è Admin</button>
      <button class="danger" onclick="logout()">Sair</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- PRODUTO -->
    <aside class="card area-product fx" id="productCard">
      <div class="head">
        <div class="title">
          <h2>Produto ativo</h2>
          <p class="subtitle">Identifica por palavras-chave + informa√ß√µes do produto (ex.: ‚ÄúAndr√© Maggi‚Äù). ‚ÄúSinop‚Äù √© ignorado.</p>
        </div>
        <div class="updated-badge" id="prodBadge">‚ú® Atualizado</div>
      </div>

      <div class="productMeta">
        <h3 class="productName" id="prod-name">Produto n√£o identificado</h3>
        <div class="row">
          <span class="chip good" id="prodChip">‚Äî</span>
          <span class="chip" style="color:var(--muted)">Entrada limpa automaticamente</span>
        </div>
        <ul class="infoList" id="prod-info"></ul>
        <p class="hint">Dica: infos espec√≠ficas ajudam a detectar por frases como ‚ÄúAndr√© Maggi‚Äù mesmo sem citar o nome do produto.</p>
      </div>
    </aside>

    <!-- INPUT -->
    <section class="card area-input fx" id="inputCard">
      <div class="head">
        <div class="title">
          <h3>Caixa de di√°logo</h3>
          <p class="subtitle">Digite ou dite. Ao processar, o texto √© limpo automaticamente para manter desempenho.</p>
        </div>
        <div class="updated-badge" id="objBadge">‚ö° Atualizado</div>
      </div>

      <div class="body inputWrap">
        <textarea id="input" placeholder="Digite ou dite o que o cliente disse..."></textarea>

        <div class="toolbar">
          <div class="btnRow">
            <button class="primary" id="micBtn" onclick="toggleListening()">üéôÔ∏è Ouvir microfone</button>
            <button class="danger" onclick="clearAll()">Limpar</button>
          </div>

          <div class="row" style="justify-content:flex-end">
            <span class="chip" id="objChip">Obje√ß√£o: ‚Äî</span>
          </div>
        </div>
      </div>
    </section>

    <!-- RESPOSTAS -->
    <section class="responsesGrid area-resp fx" id="responsesWrap">

      <div class="card responseCard">
        <div class="head">
          <div class="title">
            <h4>Quebra Leve</h4>
            <p class="subtitle">Acolhe + direciona com pergunta (cliente frio).</p>
          </div>
          <span class="chip good">Leve</span>
        </div>
        <div class="body">
          <p id="r1" class="responseText">‚Äî</p>
          <div class="responseFooter">
            <span class="chip">Tom: humano e consultivo</span>
            <button onclick="copy('r1')">Copiar</button>
          </div>
        </div>
      </div>

      <div class="card responseCard">
        <div class="head">
          <div class="title">
            <h4>Quebra M√©dia</h4>
            <p class="subtitle">Reenquadra + pede crit√©rio (puxa o pr√≥ximo passo).</p>
          </div>
          <span class="chip warn">M√©dia</span>
        </div>
        <div class="body">
          <p id="r2" class="responseText">‚Äî</p>
          <div class="responseFooter">
            <span class="chip">Tom: firme, sem press√£o</span>
            <button onclick="copy('r2')">Copiar</button>
          </div>
        </div>
      </div>

      <div class="card responseCard">
        <div class="head">
          <div class="title">
            <h4>Quebra Agressiva</h4>
            <p class="subtitle">Custo da ina√ß√£o + decis√£o (direto, sem grosseria).</p>
          </div>
          <span class="chip bad">Agressiva</span>
        </div>
        <div class="body">
          <p id="r3" class="responseText">‚Äî</p>
          <div class="responseFooter">
            <span class="chip">Tom: objetivo e decisivo</span>
            <button onclick="copy('r3')">Copiar</button>
          </div>
        </div>
      </div>

    </section>

  </div>
</main>

<!-- ADMIN DRAWER -->
<div id="adminDrawer" class="drawer">
  <div class="backdrop" onclick="closeAdmin()"></div>
  <div class="panel">
    <div class="panelHeader">
      <div>
        <h2>Admin ‚Äî Gerenciar base (Produtos / Obje√ß√µes / Usu√°rios)</h2>
        <p class="subtitle" style="margin-top:4px">S√≥ o admin pode editar. Ao final, exporte a base e substitua este index.html no GitHub.</p>
      </div>
      <button class="danger" onclick="closeAdmin()">Fechar</button>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabProducts" onclick="setTab('products')">Produtos</button>
      <button class="tabBtn" id="tabObjections" onclick="setTab('objections')">Obje√ß√µes</button>
      <button class="tabBtn" id="tabUsers" onclick="setTab('users')">Usu√°rios</button>
      <button class="tabBtn" id="tabExport" onclick="setTab('export')">Exportar/Importar</button>
    </div>

    <div class="panelBody">
      <!-- PRODUCTS TAB -->
      <div id="viewProducts">
        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Novo / Editar Produto</h3>
              <p class="subtitle">Busca por <strong>keys + infos</strong>. ‚ÄúSinop‚Äù √© ignorado automaticamente.</p>
            </div>
            <span class="chip" id="prodEditState">Modo: adicionar</span>
          </div>
          <div class="body">
            <div class="formGrid">
              <div>
                <label>Nome do produto</label>
                <input id="pName" type="text" placeholder="ex: CEDROS JARDINS" />
              </div>
              <div>
                <label>Palavras-chave (separe por v√≠rgula)</label>
                <input id="pKeys" type="text" placeholder="ex: cedros, b√∫falo, posto b√∫falo" />
              </div>
              <div>
                <label>Informa√ß√µes do produto (1 por linha)</label>
                <textarea id="pInfo" class="smallArea" placeholder="ex:
Lotes 200 m¬≤
Parcelas a partir de R$ 753
Entrada: n√£o
Av. Andr√© Maggi"></textarea>
              </div>

              <div class="row" style="justify-content:flex-end">
                <button class="ghost" onclick="resetProductForm()">Limpar</button>
                <button class="primary" onclick="saveProduct()">Salvar produto</button>
              </div>
              <p class="muted">Dica: infos espec√≠ficas detectam frases como ‚ÄúAndr√© Maggi‚Äù mesmo sem citar o nome do produto.</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Produtos cadastrados</h3>
              <p class="subtitle">Clique em ‚ÄúEditar‚Äù para carregar no formul√°rio.</p>
            </div>
            <span class="chip" id="countProducts">0</span>
          </div>
          <div class="body">
            <div class="list" id="productsList"></div>
          </div>
        </div>
      </div>

      <!-- OBJECTIONS TAB -->
      <div id="viewObjections" style="display:none">
        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Novo / Editar Obje√ß√£o</h3>
              <p class="subtitle">Detec√ß√£o por palavras-chave (match no texto). Retorna 3 respostas.</p>
            </div>
            <span class="chip" id="objEditState">Modo: adicionar</span>
          </div>
          <div class="body">
            <div class="formGrid">
              <div>
                <label>Palavras-chave da obje√ß√£o (v√≠rgula)</label>
                <input id="oKeys" type="text" placeholder="ex: caro, pre√ßo alto, muito caro" />
              </div>

              <div class="formGrid three">
                <div>
                  <label>Quebra Leve</label>
                  <textarea id="oA" class="smallArea" placeholder="Valida + pergunta curta..."></textarea>
                </div>
                <div>
                  <label>Quebra M√©dia</label>
                  <textarea id="oB" class="smallArea" placeholder="Reenquadra + pede crit√©rio..."></textarea>
                </div>
                <div>
                  <label>Quebra Agressiva</label>
                  <textarea id="oC" class="smallArea" placeholder="Custo da ina√ß√£o + decis√£o..."></textarea>
                </div>
              </div>

              <div class="row" style="justify-content:flex-end">
                <button class="ghost" onclick="resetObjectionForm()">Limpar</button>
                <button class="primary" onclick="saveObjection()">Salvar obje√ß√£o</button>
              </div>
              <p class="muted">Dica: adicione sin√¥nimos nas keywords para detectar mais falas diferentes do cliente.</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Obje√ß√µes cadastradas</h3>
              <p class="subtitle">Clique em ‚ÄúEditar‚Äù para carregar no formul√°rio.</p>
            </div>
            <span class="chip" id="countObjections">0</span>
          </div>
          <div class="body">
            <div class="list" id="objectionsList"></div>
          </div>
        </div>
      </div>

      <!-- USERS TAB -->
      <div id="viewUsers" style="display:none">
        <div class="notice">
          <strong>Admin fixo:</strong> login <code>edson</code> / senha <code>2026</code>. Ele sempre existir√° e n√£o pode ser removido.
          <br>Usu√°rios abaixo s√≥ podem <strong>usar</strong> (n√£o editam).
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Criar / Editar Usu√°rio</h3>
              <p class="subtitle">Os usu√°rios comuns n√£o veem o painel Admin.</p>
            </div>
            <span class="chip" id="userEditState">Modo: adicionar</span>
          </div>
          <div class="body">
            <div class="formGrid two">
              <div>
                <label>Login</label>
                <input id="uLogin" type="text" placeholder="ex: vendedor1" />
              </div>
              <div>
                <label>Senha</label>
                <input id="uPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
            </div>

            <div class="row" style="justify-content:flex-end; margin-top:10px">
              <button class="ghost" onclick="resetUserForm()">Limpar</button>
              <button class="primary" onclick="saveUser()">Salvar usu√°rio</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Usu√°rios cadastrados</h3>
              <p class="subtitle">Exceto admin, voc√™ pode remover/editar.</p>
            </div>
            <span class="chip" id="countUsers">0</span>
          </div>
          <div class="body">
            <div class="list" id="usersList"></div>
          </div>
        </div>
      </div>

      <!-- EXPORT TAB -->
      <div id="viewExport" style="display:none">
        <div class="success">
          <strong>Fluxo simples:</strong> Exportar base completa ‚Üí copiar ‚Üí no GitHub abrir <code>index.html</code> ‚Üí Ctrl+A ‚Üí apagar ‚Üí colar ‚Üí salvar.
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Exportar base completa</h3>
              <p class="subtitle">Produtos + Obje√ß√µes + Usu√°rios (admin √© fixo).</p>
            </div>
            <button class="primary" onclick="exportBase()">Exportar</button>
          </div>
          <div class="body">
            <label>Base exportada (copie tudo)</label>
            <textarea id="exportOut" class="smallArea" style="min-height:220px" placeholder="Clique em Exportar..."></textarea>
            <div class="row" style="justify-content:flex-end; margin-top:10px">
              <button onclick="copyExport()">Copiar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="title">
              <h3>Importar base</h3>
              <p class="subtitle">Cole uma base exportada aqui e aplique (salva no navegador).</p>
            </div>
            <button class="primary" onclick="importBase()">Aplicar</button>
          </div>
          <div class="body">
            <label>Base para importar</label>
            <textarea id="importIn" class="smallArea" style="min-height:220px" placeholder="Cole aqui a base exportada..."></textarea>

            <div class="row" style="justify-content:space-between; margin-top:10px">
              <button class="danger" onclick="resetToDefaults()">Restaurar padr√£o</button>
              <span class="chip" id="importStatus">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div><!-- panelBody -->
  </div><!-- panel -->
</div><!-- drawer -->

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="mini"></span>
  <span id="toastText">OK</span>
</div>

<script>
/* ===================== BASE PADR√ÉO ===================== */
const DEFAULT_BASE = {
  products: [
    {name:"MORADA BRASIL", keys:["morada"], info:["Loteamento residencial","Parcelas a partir de R$ 713","Entrada: n√£o","Av. Andr√© Maggi"]},
    {name:"CASA PRONTA ‚Äì SINOP", keys:["casa","mcmv"], info:["Casa 2 quartos","Parcelas a partir de R$ 699","Entrada: R$ 1.500","Financiamento Caixa"]},
    {name:"CH√ÅCARAS ‚Äì SANTA CARMEM", keys:["chacara","ch√°cara"], info:["1.800 m¬≤","Parcelas a partir de R$ 695","Entrada: n√£o","6 km de Santa Carmem"]},
    {name:"GRAN CAN√ÅRIO", keys:["canario","gran"], info:["Loteamento urbano","Parcelas a partir de R$ 595","Entrada: sim / n√£o","MT-140"]},
    {name:"CEDROS JARDINS", keys:["cedros","b√∫falo"], info:["Lotes 200 m¬≤","Parcelas a partir de R$ 753","Entrada: n√£o","Posto B√∫falo"]}
  ],
  objections: [
    { keys:["caro","muito caro","valor alto","pre√ßo alto"],
      a:"Entendo totalmente. S√≥ pra eu te orientar certo: quando voc√™ diz caro, √© pelo valor total ou pela parcela?",
      b:"Caro comparado com qual op√ß√£o? Se for s√≥ condi√ß√£o, eu consigo te mostrar o melhor encaixe pro seu bolso.",
      c:"Se eu ajustar pra caber sem te apertar (entrada/parcela/prazo), voc√™ avan√ßa agora ou ainda fica em d√∫vida?"
    },
    { keys:["or√ßamento","sem or√ßamento","estourado","limite","apertado"],
      a:"Faz sentido cuidar do or√ßamento. Qual faixa mensal fica confort√°vel pra voc√™ hoje?",
      b:"O ponto √© a parcela ou o prazo? Se me disser o limite, eu te passo a melhor configura√ß√£o.",
      c:"Se eu encaixar dentro do seu limite sem surpresa, voc√™ d√° o pr√≥ximo passo ou prefere encerrar?"
    },
    { keys:["vou pensar","pensar","analisar","vou analisar","ver depois","vou ver"],
      a:"Perfeito, analisar √© o certo. O que voc√™ quer avaliar primeiro: pre√ßo, condi√ß√£o ou localiza√ß√£o?",
      b:"Pra sua an√°lise n√£o virar s√≥ ‚Äúdeixar pra depois‚Äù: o que precisa acontecer pra virar um sim?",
      c:"Se nada mudar nas condi√ß√µes, sua resposta tende mais pra sim ou pra n√£o? S√≥ pra eu n√£o te prender aqui."
    },
    { keys:["depois","mais pra frente","n√£o agora","agora n√£o","outro momento","n√£o √© o momento"],
      a:"Tudo bem. O que faz n√£o ser o momento: grana, prioridade ou inseguran√ßa?",
      b:"S√≥ pra eu te ajudar: quando seria um bom timing? Semana que vem, m√™s que vem‚Ä¶ o que voc√™ tem em mente?",
      c:"Se a condi√ß√£o mudar e ficar pior depois, tudo bem pra voc√™? Ou prefere garantir agora e ir ajustando no caminho?"
    },
    { keys:["esposa","marido","familia","fam√≠lia","minha mulher","meu marido"],
      a:"Claro, faz sentido alinhar. O que ela(e) costuma perguntar primeiro: parcela, localiza√ß√£o ou seguran√ßa?",
      b:"Me diz a d√∫vida principal dele(a) que eu te mando uma mensagem curta pronta pra voc√™ encaminhar.",
      c:"Se ele(a) disser ok com a condi√ß√£o, voc√™ fecha? Porque a√≠ eu te ajudo a conduzir do jeito mais r√°pido."
    },
    { keys:["comparar","comparando","vou ver outro","outros","mais barato em outro lugar","tem outro"],
      a:"Normal comparar. Voc√™ t√° comparando mais pelo pre√ßo ou pela localiza√ß√£o?",
      b:"Pra comparar certo, olha 3 pontos: documenta√ß√£o, acesso/local e potencial de valoriza√ß√£o. Qual deles te chama mais aten√ß√£o?",
      c:"Se eu te provar que aqui faz mais sentido no conjunto (n√£o s√≥ no pre√ßo), voc√™ decide por aqui?"
    },
    { keys:["medo","receio","inseguro","inseguran√ßa","n√£o confio","desconfio","golpe"],
      a:"Just√≠ssimo. Medo de qu√™ exatamente: documenta√ß√£o, localiza√ß√£o ou experi√™ncia passada?",
      b:"Pra voc√™ ficar tranquilo: eu te mostro o b√°sico que valida tudo (mapa/registro/condi√ß√£o por escrito). O que voc√™ quer ver primeiro?",
      c:"Voc√™ prefere validar por documento agora ou por visita? Se a valida√ß√£o ficar ok, voc√™ avan√ßa?"
    }
  ],
  users: [
    { login:"vendedor", pass:"1234" }
  ]
};

/* ===================== STORAGE ===================== */
const LS_BASE = "copiloto_base_v5";
const LS_SESSION = "copiloto_session_v2";
const LS_WELCOME = "copiloto_welcome_seen_v1";

/* ===================== AUTO-LIMPAR ENTRADA (NOVO) ===================== */
const AUTO_CLEAR_ENABLED = true;
const AUTO_CLEAR_TYPING_MS = 900; // ap√≥s parar de digitar
let autoClearTimer = null;

/* ===================== ESTADO GLOBAL ===================== */
let base = { products:[], objections:[], users:[] };
let currentUser = null;

let editingProductIndex = null;
let editingObjectionIndex = null;
let editingUserIndex = null;

let lastProduct = null;      // mant√©m √∫ltimo produto ativo
let lastObjection = null;    // mant√©m √∫ltima obje√ß√£o (assinatura)
let lastObjectionKey = "";
let lastTextProcessed = "";

/* ===================== ELEMENTOS ===================== */
const input = document.getElementById("input");
const r1 = document.getElementById("r1");
const r2 = document.getElementById("r2");
const r3 = document.getElementById("r3");

const prodNameEl = document.getElementById("prod-name");
const prodInfoEl = document.getElementById("prod-info");
const prodCard = document.getElementById("productCard");
const prodBadge = document.getElementById("prodBadge");
const prodChip = document.getElementById("prodChip");

const objChip = document.getElementById("objChip");
const objBadge = document.getElementById("objBadge");
const responsesWrap = document.getElementById("responsesWrap");

const toast = document.getElementById("toast");
const toastText = document.getElementById("toastText");

const micDot = document.getElementById("micDot");
const micLabel = document.getElementById("micLabel");
const micBtn = document.getElementById("micBtn");

const rolePill = document.getElementById("rolePill");
const adminBtn = document.getElementById("adminBtn");

const loginOverlay = document.getElementById("loginOverlay");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const rememberMe = document.getElementById("rememberMe");
const loginError = document.getElementById("loginError");

const welcome = document.getElementById("welcome");

/* Admin drawer */
const adminDrawer = document.getElementById("adminDrawer");
const viewProducts = document.getElementById("viewProducts");
const viewObjections = document.getElementById("viewObjections");
const viewUsers = document.getElementById("viewUsers");
const viewExport = document.getElementById("viewExport");

const tabProducts = document.getElementById("tabProducts");
const tabObjections = document.getElementById("tabObjections");
const tabUsers = document.getElementById("tabUsers");
const tabExport = document.getElementById("tabExport");

const productsList = document.getElementById("productsList");
const objectionsList = document.getElementById("objectionsList");
const usersList = document.getElementById("usersList");

const countProducts = document.getElementById("countProducts");
const countObjections = document.getElementById("countObjections");
const countUsers = document.getElementById("countUsers");

const prodEditState = document.getElementById("prodEditState");
const objEditState = document.getElementById("objEditState");
const userEditState = document.getElementById("userEditState");

const pName = document.getElementById("pName");
const pKeys = document.getElementById("pKeys");
const pInfo = document.getElementById("pInfo");

const oKeys = document.getElementById("oKeys");
const oA = document.getElementById("oA");
const oB = document.getElementById("oB");
const oC = document.getElementById("oC");

const uLogin = document.getElementById("uLogin");
const uPass = document.getElementById("uPass");

const exportOut = document.getElementById("exportOut");
const importIn = document.getElementById("importIn");
const importStatus = document.getElementById("importStatus");

/* ===================== UTIL ===================== */
function showToast(msg){
  toastText.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.classList.remove("show"), 1400);
}
function flashUpdated(elBadge){
  elBadge.classList.add("show");
  setTimeout(()=> elBadge.classList.remove("show"), 1000);
}
function animateUpdate(elCard){
  elCard.classList.add("fxPulse","fxSlideFade","highlightBorder");
  setTimeout(()=>{
    elCard.classList.remove("fxPulse","fxSlideFade","highlightBorder");
  }, 780);
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalizeText(str){
  return String(str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

/* ===================== AUTO-CLEAR (NOVO) ===================== */
function clearInputNow(){
  input.value = "";
  lastTextProcessed = ""; // garante que a pr√≥xima entrada sempre processe
}
function scheduleAutoClearAfterTyping(){
  if(!AUTO_CLEAR_ENABLED) return;
  clearTimeout(autoClearTimer);
  autoClearTimer = setTimeout(()=>{
    // s√≥ limpa se ainda tiver conte√∫do (evita "piscar" desnecess√°rio)
    if((input.value || "").trim()){
      clearInputNow();
    }
  }, AUTO_CLEAR_TYPING_MS);
}

/* ===================== MATCH DE PRODUTO (keys + info, ignorando "sinop") ===================== */
const PRODUCT_IGNORE_TERMS = new Set(["sinop"]);
const INFO_PREFIX_IGNORE = new Set(["av","avenida","rua","rodovia","br","mt","km","santa","carmem"]);

function buildProductTerms(product){
  const raw = [
    ...(product.keys || []),
    ...(product.info || [])
  ].map(normalizeText).filter(Boolean);

  const terms = new Set();

  for(const line of raw){
    if(!line) continue;
    if(PRODUCT_IGNORE_TERMS.has(line)) continue;

    if(line.length >= 4) terms.add(line);

    const words = line.split(" ").filter(Boolean);
    const cleaned = words.filter(w => w.length >= 3 && !PRODUCT_IGNORE_TERMS.has(w) && !INFO_PREFIX_IGNORE.has(w));

    for(let n=2; n<=4; n++){
      for(let i=0; i<=cleaned.length-n; i++){
        const gram = cleaned.slice(i, i+n).join(" ");
        if(gram.length >= 5 && !PRODUCT_IGNORE_TERMS.has(gram)) terms.add(gram);
      }
    }

    for(const w of cleaned){
      if(w.length >= 4 && !PRODUCT_IGNORE_TERMS.has(w)) terms.add(w);
    }
  }

  return Array.from(terms);
}

function productMatchesText(product, textNorm){
  const terms = buildProductTerms(product);
  return terms.some(term => term && textNorm.includes(term));
}

/* ===================== BASE LOAD/SAVE ===================== */
function structuredClone(obj){
  return JSON.parse(JSON.stringify(obj));
}
function loadBase(){
  const saved = localStorage.getItem(LS_BASE);
  if(saved){
    try{
      const parsed = JSON.parse(saved);
      if(parsed && Array.isArray(parsed.products) && Array.isArray(parsed.objections) && Array.isArray(parsed.users)){
        base = parsed;
        return;
      }
    }catch(e){}
  }
  base = structuredClone(DEFAULT_BASE);
  saveBase();
}
function saveBase(){
  localStorage.setItem(LS_BASE, JSON.stringify(base));
}

/* ===================== LOGIN ===================== */
function getSession(){
  const s = localStorage.getItem(LS_SESSION) || sessionStorage.getItem(LS_SESSION);
  if(!s) return null;
  try{
    const parsed = JSON.parse(s);
    if(parsed && parsed.login && parsed.role) return parsed;
  }catch(e){}
  return null;
}
function setSession(sess, remember){
  const str = JSON.stringify(sess);
  if(remember) localStorage.setItem(LS_SESSION, str);
  else sessionStorage.setItem(LS_SESSION, str);
}
function clearSession(){
  localStorage.removeItem(LS_SESSION);
  sessionStorage.removeItem(LS_SESSION);
}

function doLogin(){
  const u = (loginUser.value || "").trim();
  const p = (loginPass.value || "").trim();
  loginError.style.display = "none";

  if(!u || !p){
    loginError.textContent = "Preencha login e senha.";
    loginError.style.display = "block";
    return;
  }

  // ADMIN FIXO
  if(u === "edson" && p === "2026"){
    currentUser = {login:"edson", role:"admin"};
    setSession(currentUser, !!rememberMe.checked);
    afterLogin();
    return;
  }

  // usu√°rio comum
  const found = (base.users || []).find(x => (x.login || "").toLowerCase() === u.toLowerCase() && String(x.pass || "") === p);
  if(found){
    currentUser = {login: found.login, role:"user"};
    setSession(currentUser, !!rememberMe.checked);
    afterLogin();
    return;
  }

  loginError.textContent = "Login ou senha inv√°lidos.";
  loginError.style.display = "block";
}

function afterLogin(){
  loginOverlay.style.display = "none";
  rolePill.textContent = `Acesso: ${currentUser.role === "admin" ? "Admin" : "Usu√°rio"} (${currentUser.login})`;
  adminBtn.style.display = (currentUser.role === "admin") ? "inline-flex" : "none";

  if(!localStorage.getItem(LS_WELCOME)){
    welcome.style.display = "flex";
  }

  renderAdminAll();
  setTimeout(()=> input.focus(), 120);
}

function logout(){
  stopListening();
  currentUser = null;
  clearSession();
  adminBtn.style.display = "none";
  rolePill.textContent = "Acesso: ‚Äî";
  closeAdmin();
  loginOverlay.style.display = "flex";
  showToast("Sess√£o encerrada");
}

function closeWelcome(){
  localStorage.setItem(LS_WELCOME, "1");
  welcome.style.display = "none";
}

/* ===================== ADMIN UI ===================== */
function openAdmin(){
  if(!currentUser || currentUser.role !== "admin") return;
  adminDrawer.classList.add("show");
  setTab("products");
  renderAdminAll();
}
function closeAdmin(){
  adminDrawer.classList.remove("show");
}
function setTab(tab){
  tabProducts.classList.toggle("active", tab==="products");
  tabObjections.classList.toggle("active", tab==="objections");
  tabUsers.classList.toggle("active", tab==="users");
  tabExport.classList.toggle("active", tab==="export");

  viewProducts.style.display = (tab==="products") ? "block" : "none";
  viewObjections.style.display = (tab==="objections") ? "block" : "none";
  viewUsers.style.display = (tab==="users") ? "block" : "none";
  viewExport.style.display = (tab==="export") ? "block" : "none";
}
function renderAdminAll(){
  renderProductsList();
  renderObjectionsList();
  renderUsersList();
  countProducts.textContent = String((base.products||[]).length);
  countObjections.textContent = String((base.objections||[]).length);
  countUsers.textContent = String((base.users||[]).length + 1); // + admin fixo
}

/* ===================== PRODUCTS CRUD ===================== */
function resetProductForm(){
  editingProductIndex = null;
  prodEditState.textContent = "Modo: adicionar";
  pName.value = "";
  pKeys.value = "";
  pInfo.value = "";
}
function saveProduct(){
  if(!currentUser || currentUser.role !== "admin") return;

  const name = (pName.value || "").trim();
  const keys = (pKeys.value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const info = (pInfo.value || "").split("\n").map(s=>s.trim()).filter(Boolean);

  if(!name){ showToast("Informe o nome do produto"); return; }
  if(keys.length === 0 && info.length === 0){ showToast("Adicione pelo menos 1 keyword ou 1 informa√ß√£o"); return; }

  const obj = {name, keys, info};

  if(editingProductIndex === null){
    base.products.push(obj);
    showToast("Produto adicionado");
  }else{
    base.products[editingProductIndex] = obj;
    showToast("Produto atualizado");
  }

  saveBase();
  renderProductsList();
  countProducts.textContent = String(base.products.length);
  resetProductForm();
}
function editProduct(i){
  const p = base.products[i];
  if(!p) return;
  editingProductIndex = i;
  prodEditState.textContent = "Modo: editar";
  pName.value = p.name || "";
  pKeys.value = (p.keys || []).join(", ");
  pInfo.value = (p.info || []).join("\n");
}
function removeProduct(i){
  if(!confirm("Remover este produto?")) return;
  base.products.splice(i,1);
  saveBase();
  renderProductsList();
  countProducts.textContent = String(base.products.length);
  showToast("Produto removido");
  lastProduct = null;
  processText(true);
}
function renderProductsList(){
  const arr = base.products || [];
  productsList.innerHTML = "";
  if(arr.length === 0){
    productsList.innerHTML = `<div class="item"><div><h5>Nenhum produto</h5><p>Cadastre acima para come√ßar.</p></div></div>`;
    return;
  }
  arr.forEach((p, i)=>{
    const keys = (p.keys || []).join(", ");
    const info = (p.info || []).slice(0,4).join(" ‚Ä¢ ");
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="min-width:0">
        <h5>${escapeHtml(p.name || "")}</h5>
        <p><strong>Keys:</strong> ${escapeHtml(keys || "‚Äî")}</p>
        <p><strong>Info:</strong> ${escapeHtml(info || "‚Äî")}</p>
      </div>
      <div class="actions">
        <button class="miniBtn" onclick="editProduct(${i})">Editar</button>
        <button class="miniBtn danger" onclick="removeProduct(${i})">Remover</button>
      </div>
    `;
    productsList.appendChild(el);
  });
}

/* ===================== OBJECTIONS CRUD ===================== */
function resetObjectionForm(){
  editingObjectionIndex = null;
  objEditState.textContent = "Modo: adicionar";
  oKeys.value = "";
  oA.value = "";
  oB.value = "";
  oC.value = "";
}
function saveObjection(){
  if(!currentUser || currentUser.role !== "admin") return;

  const keys = (oKeys.value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const a = (oA.value || "").trim();
  const b = (oB.value || "").trim();
  const c = (oC.value || "").trim();

  if(keys.length === 0){ showToast("Informe as palavras-chave da obje√ß√£o"); return; }
  if(!a || !b || !c){ showToast("Preencha as 3 respostas (leve/m√©dia/agressiva)"); return; }

  const obj = {keys, a, b, c};

  if(editingObjectionIndex === null){
    base.objections.push(obj);
    showToast("Obje√ß√£o adicionada");
  }else{
    base.objections[editingObjectionIndex] = obj;
    showToast("Obje√ß√£o atualizada");
  }

  saveBase();
  renderObjectionsList();
  countObjections.textContent = String(base.objections.length);
  resetObjectionForm();
}
function editObjection(i){
  const o = base.objections[i];
  if(!o) return;
  editingObjectionIndex = i;
  objEditState.textContent = "Modo: editar";
  oKeys.value = (o.keys || []).join(", ");
  oA.value = o.a || "";
  oB.value = o.b || "";
  oC.value = o.c || "";
}
function removeObjection(i){
  if(!confirm("Remover esta obje√ß√£o?")) return;
  base.objections.splice(i,1);
  saveBase();
  renderObjectionsList();
  countObjections.textContent = String(base.objections.length);
  showToast("Obje√ß√£o removida");
  lastObjection = null;
  lastObjectionKey = "";
  processText(true);
}
function renderObjectionsList(){
  const arr = base.objections || [];
  objectionsList.innerHTML = "";
  if(arr.length === 0){
    objectionsList.innerHTML = `<div class="item"><div><h5>Nenhuma obje√ß√£o</h5><p>Cadastre acima para come√ßar.</p></div></div>`;
    return;
  }
  arr.forEach((o, i)=>{
    const keys = (o.keys || []).join(", ");
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="min-width:0">
        <h5>${escapeHtml(keys || "‚Äî")}</h5>
        <p><strong>Leve:</strong> ${escapeHtml((o.a||"").slice(0,120))}${(o.a||"").length>120?"‚Ä¶":""}</p>
        <p><strong>M√©dia:</strong> ${escapeHtml((o.b||"").slice(0,120))}${(o.b||"").length>120?"‚Ä¶":""}</p>
        <p><strong>Agressiva:</strong> ${escapeHtml((o.c||"").slice(0,120))}${(o.c||"").length>120?"‚Ä¶":""}</p>
      </div>
      <div class="actions">
        <button class="miniBtn" onclick="editObjection(${i})">Editar</button>
        <button class="miniBtn danger" onclick="removeObjection(${i})">Remover</button>
      </div>
    `;
    objectionsList.appendChild(el);
  });
}

/* ===================== USERS CRUD ===================== */
function resetUserForm(){
  editingUserIndex = null;
  userEditState.textContent = "Modo: adicionar";
  uLogin.value = "";
  uPass.value = "";
}
function saveUser(){
  if(!currentUser || currentUser.role !== "admin") return;

  const login = (uLogin.value || "").trim();
  const pass = (uPass.value || "").trim();

  if(!login){ showToast("Informe o login"); return; }
  if(login.toLowerCase() === "edson"){ showToast("‚Äúedson‚Äù √© reservado para o admin fixo"); return; }
  if(!pass){ showToast("Informe a senha"); return; }

  const existsIndex = (base.users || []).findIndex(u => (u.login||"").toLowerCase() === login.toLowerCase());
  const obj = {login, pass};

  if(editingUserIndex === null){
    if(existsIndex !== -1){ showToast("J√° existe um usu√°rio com esse login"); return; }
    base.users.push(obj);
    showToast("Usu√°rio criado");
  }else{
    base.users[editingUserIndex] = obj;
    showToast("Usu√°rio atualizado");
  }

  saveBase();
  renderUsersList();
  countUsers.textContent = String((base.users||[]).length + 1);
  resetUserForm();
}
function editUser(i){
  const u = base.users[i];
  if(!u) return;
  editingUserIndex = i;
  userEditState.textContent = "Modo: editar";
  uLogin.value = u.login || "";
  uPass.value = u.pass || "";
}
function removeUser(i){
  const u = base.users[i];
  if(!u) return;
  if(!confirm("Remover este usu√°rio?")) return;
  base.users.splice(i,1);
  saveBase();
  renderUsersList();
  countUsers.textContent = String((base.users||[]).length + 1);
  showToast("Usu√°rio removido");
}
function renderUsersList(){
  usersList.innerHTML = "";
  const adminEl = document.createElement("div");
  adminEl.className = "item";
  adminEl.innerHTML = `
    <div style="min-width:0">
      <h5>edson <span class="chip good" style="margin-left:8px">Admin</span></h5>
      <p>Admin fixo do sistema (pode editar tudo).</p>
    </div>
    <div class="actions">
      <button class="miniBtn" disabled title="Admin fixo">Fixado</button>
    </div>
  `;
  usersList.appendChild(adminEl);

  const arr = base.users || [];
  if(arr.length === 0){
    const empty = document.createElement("div");
    empty.className = "item";
    empty.innerHTML = `<div><h5>Nenhum usu√°rio comum</h5><p>Crie usu√°rios para uso (sem edi√ß√£o).</p></div>`;
    usersList.appendChild(empty);
    return;
  }
  arr.forEach((u, i)=>{
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="min-width:0">
        <h5>${escapeHtml(u.login || "")} <span class="chip" style="margin-left:8px">Usu√°rio</span></h5>
        <p>Sem acesso ao painel Admin.</p>
      </div>
      <div class="actions">
        <button class="miniBtn" onclick="editUser(${i})">Editar</button>
        <button class="miniBtn danger" onclick="removeUser(${i})">Remover</button>
      </div>
    `;
    usersList.appendChild(el);
  });
}

/* ===================== EXPORT/IMPORT ===================== */
function exportBase(){
  if(!currentUser || currentUser.role !== "admin") return;
  exportOut.value = JSON.stringify(structuredClone(base), null, 2);
  showToast("Base exportada (copie tudo)");
  importStatus.textContent = "‚Äî";
}
function copyExport(){
  const txt = (exportOut.value || "").trim();
  if(!txt){ showToast("Nada para copiar"); return; }
  navigator.clipboard.writeText(txt).then(()=> showToast("Copiado ‚úÖ")).catch(()=> showToast("N√£o foi poss√≠vel copiar"));
}
function importBase(){
  if(!currentUser || currentUser.role !== "admin") return;
  const txt = (importIn.value || "").trim();
  if(!txt){ importStatus.textContent = "Cole uma base primeiro"; return; }
  try{
    const parsed = JSON.parse(txt);
    if(!parsed || !Array.isArray(parsed.products) || !Array.isArray(parsed.objections) || !Array.isArray(parsed.users)){
      importStatus.textContent = "Formato inv√°lido";
      return;
    }
    base = parsed;
    saveBase();
    renderAdminAll();
    importStatus.textContent = "Base aplicada ‚úÖ";
    showToast("Base importada");
    lastProduct = null; lastObjection = null; lastObjectionKey = "";
    processText(true);
  }catch(e){
    importStatus.textContent = "JSON inv√°lido";
  }
}
function resetToDefaults(){
  if(!currentUser || currentUser.role !== "admin") return;
  if(!confirm("Restaurar a base padr√£o?")) return;
  base = structuredClone(DEFAULT_BASE);
  saveBase();
  renderAdminAll();
  showToast("Padr√£o restaurado");
  importStatus.textContent = "Padr√£o restaurado";
  lastProduct = null; lastObjection = null; lastObjectionKey = "";
  processText(true);
}

/* ===================== CORE ===================== */
function processText(force){
  const tRaw = input.value || "";
  const tNorm = normalizeText(tRaw);

  if(!force && tNorm === lastTextProcessed) return;
  lastTextProcessed = tNorm;

  // Produto
  const products = base.products || [];
  const p = products.find(prod => productMatchesText(prod, tNorm));

  if(p){
    if(!lastProduct || lastProduct.name !== p.name){
      prodNameEl.textContent = p.name;
      prodInfoEl.innerHTML = (p.info || []).map(i => "<li>"+escapeHtml(i)+"</li>").join("");
      prodChip.textContent = "Ativo";
      lastProduct = p;
      flashUpdated(prodBadge);
      animateUpdate(prodCard);
    }else{
      prodNameEl.textContent = lastProduct.name;
      prodInfoEl.innerHTML = (lastProduct.info || []).map(i => "<li>"+escapeHtml(i)+"</li>").join("");
      prodChip.textContent = "Ativo";
    }
  }else{
    if(lastProduct){
      prodNameEl.textContent = lastProduct.name;
      prodInfoEl.innerHTML = (lastProduct.info || []).map(i => "<li>"+escapeHtml(i)+"</li>").join("");
      prodChip.textContent = "Ativo";
    }else{
      prodNameEl.textContent = "Produto n√£o identificado";
      prodInfoEl.innerHTML = "";
      prodChip.textContent = "‚Äî";
    }
  }

  // Obje√ß√£o
  const objections = base.objections || [];
  const o = objections.find(obj => (obj.keys || []).some(k => tNorm.includes(normalizeText(k))));

  if(o){
    const hit = (o.keys || []).map(normalizeText).find(k => k && tNorm.includes(k)) || "";
    const signature = (o.a + "||" + o.b + "||" + o.c);

    if(!lastObjection || lastObjection.signature !== signature){
      r1.textContent = o.a || "‚Äî";
      r2.textContent = o.b || "‚Äî";
      r3.textContent = o.c || "‚Äî";

      lastObjection = { signature };
      lastObjectionKey = hit;
      objChip.textContent = "Obje√ß√£o: " + (hit ? ("‚Äú" + hit + "‚Äù") : "detectada");

      flashUpdated(objBadge);
      animateUpdate(responsesWrap);
    }else{
      objChip.textContent = "Obje√ß√£o: " + (lastObjectionKey ? ("‚Äú" + lastObjectionKey + "‚Äù") : "detectada");
    }
  }else{
    if(lastObjection){
      objChip.textContent = "Obje√ß√£o: " + (lastObjectionKey ? ("‚Äú" + lastObjectionKey + "‚Äù") : "‚Äî");
    }else{
      objChip.textContent = "Obje√ß√£o: ‚Äî";
    }
  }
}

/* ===================== COPY/CLEAR ===================== */
function copy(id){
  const text = (document.getElementById(id).innerText || "").trim();
  if(!text || text === "‚Äî") { showToast("Nada para copiar"); return; }
  navigator.clipboard.writeText(text)
    .then(()=> showToast("Copiado ‚úÖ"))
    .catch(()=> showToast("N√£o foi poss√≠vel copiar"));
}
function clearAll(){
  input.value = "";
  lastTextProcessed = "";
  lastProduct = null;
  lastObjection = null;
  lastObjectionKey = "";

  prodNameEl.textContent = "Produto n√£o identificado";
  prodInfoEl.innerHTML = "";
  prodChip.textContent = "‚Äî";
  objChip.textContent = "Obje√ß√£o: ‚Äî";

  r1.textContent = "‚Äî";
  r2.textContent = "‚Äî";
  r3.textContent = "‚Äî";

  animateUpdate(document.getElementById("inputCard"));
}

/* ===================== MICROFONE (manual) ===================== */
let recognition = null;
let listening = false;

function toggleListening(){
  if(listening){ stopListening(); return; }
  startListening();
}
function startListening(){
  if(!('webkitSpeechRecognition' in window)){
    alert("Seu navegador n√£o suporta reconhecimento de voz.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "pt-BR";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    listening = true;
    micDot.classList.add("on");
    micLabel.textContent = "Microfone: ouvindo";
    micBtn.textContent = "‚èπÔ∏è Parar microfone";
    micBtn.classList.add("danger");
    micBtn.classList.remove("primary");
  };

  recognition.onend = () => {
    listening = false;
    micDot.classList.remove("on");
    micLabel.textContent = "Microfone: desligado";
    micBtn.textContent = "üéôÔ∏è Ouvir microfone";
    micBtn.classList.remove("danger");
    micBtn.classList.add("primary");
  };

  recognition.onerror = () => { listening = false; };

  recognition.onresult = (e) => {
    const transcript = e.results?.[0]?.[0]?.transcript || "";
    if(transcript){
      // processa o trecho novo
      input.value = transcript;
      processText(true);
      animateUpdate(document.getElementById("inputCard"));

      // NOVO: limpa imediatamente ap√≥s receber do microfone
      if(AUTO_CLEAR_ENABLED){
        clearInputNow();
      }
    }
  };

  recognition.start();
}
function stopListening(){
  try{ recognition && recognition.stop(); }catch(e){}
}

/* ===================== EVENTOS ===================== */
input.addEventListener("input", ()=>{
  // processa (para mostrar produto/obje√ß√£o)
  processText(false);
  // NOVO: auto-limpa depois que parar de digitar (mant√©m leve)
  scheduleAutoClearAfterTyping();
});

// Ctrl+K limpar
window.addEventListener("keydown", (e)=>{
  const isMac = navigator.platform.toUpperCase().includes("MAC");
  const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
  if(ctrlOrCmd && e.key.toLowerCase() === "k"){
    e.preventDefault();
    clearAll();
  }
  if(e.key === "Enter" && loginOverlay.style.display !== "none"){
    doLogin();
  }
});

/* ===================== BOOT ===================== */
(function init(){
  loadBase();

  const sess = getSession();
  if(sess){
    currentUser = sess;
    afterLogin();
  }else{
    loginOverlay.style.display = "flex";
  }

  processText(true);
})();
</script>

</body>
</html>
