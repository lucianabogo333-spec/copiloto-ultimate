<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>COPILOTO PRO ‚Äî Fechamento Imobili√°rio</title>

<style>
/* ===================== THEME ===================== */
:root{
  --bg:#f5f7fb;
  --panel:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;

  --primary:#4f46e5;
  --primary-strong:#4338ca;
  --neon:#22c55e;
  --danger:#ef4444;
  --warn:#f59e0b;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}
[data-theme="dark"]{
  --bg:#020617;
  --panel:#0b1220;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1e293b;
  --shadow:0 12px 40px rgba(0,0,0,.55);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* ===================== HEADER ===================== */
header{
  position:sticky; top:0; z-index:10;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
}
.top{
  max-width:1400px;
  margin:auto;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
}
.brand h1{margin:0;font-size:20px;font-weight:900}
.brand span{font-size:12px;color:var(--muted)}

.btn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel);
  cursor:pointer;
  font-weight:800;
}
.btn-primary{
  background:linear-gradient(180deg,var(--primary),var(--primary-strong));
  color:#fff;border:none;
}
.btn-neon{
  background:rgba(34,197,94,.15);
  color:var(--neon);
  border:1px solid rgba(34,197,94,.5);
  box-shadow:0 0 18px rgba(34,197,94,.35);
}
.btn-danger{
  background:rgba(239,68,68,.12);
  color:var(--danger);
  border:1px solid rgba(239,68,68,.4);
}
.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
}

/* ===================== LAYOUT ===================== */
main{
  max-width:1400px;
  margin:auto;
  padding:24px;
}
.grid{
  display:grid;
  grid-template-columns:320px 1fr 420px;
  gap:20px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .chead{
  padding:16px;
  border-bottom:1px solid var(--border);
}
.card .chead h2{margin:0;font-size:15px}
.card .body{padding:16px}

/* ===================== LOGIN ===================== */
.overlay{
  position:fixed; inset:0;
  display:none;
  background:rgba(0,0,0,.65);
  z-index:100;
  align-items:center;
  justify-content:center;
}
.overlay.show{display:flex}
.login-card{
  width:min(520px,100%);
  background:var(--panel);
  border-radius:18px;
  border:1px solid var(--border);
}
.login-head{padding:16px;border-bottom:1px solid var(--border)}
.login-body{padding:16px}
.inp{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap}

@media(max-width:1100px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body data-theme="light">

<!-- LOGIN -->
<div class="overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-head">
      <h3>üîê Login ‚Äî COPILOTO PRO</h3>
      <p class="small">Admin edita tudo ‚Ä¢ Usu√°rio apenas usa</p>
    </div>
    <div class="login-body">
      <div class="row">
        <input class="inp" id="loginUser" placeholder="Usu√°rio">
        <input class="inp" id="loginPass" placeholder="Senha" type="password">
      </div>
      <label class="small">
        <input type="checkbox" id="rememberSession" checked> Lembrar sess√£o
      </label>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" id="btnLogin">Entrar</button>
        <button class="btn" id="btnLoginDemo">Demo</button>
      </div>
      <div class="small" id="loginMsg"></div>
    </div>
  </div>
</div>

<header>
  <div class="top">
    <div class="brand">
      <h1>COPILOTO PRO</h1>
      <span>Fechamento imobili√°rio em tempo real</span>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btn-neon" id="btnFormalizacao">üìÑ Formaliza√ß√£o</button>
      <button class="btn btn-neon" id="btnSimulador">üßÆ Simulador</button>
      <button class="btn" id="toggleTheme">üåô / ‚òÄÔ∏è</button>
      <button class="btn btn-danger" id="btnExit">Sair</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <aside class="card">
      <div class="chead">
        <h2>Produto ativo</h2>
      </div>
      <div class="body" id="productBox">
        <div class="small">Nenhum produto selecionado</div>
      </div>
    </aside>

    <section class="card">
      <div class="chead">
        <h2>Fala do cliente</h2>
      </div>
      <div class="body">
        <textarea id="inputText" style="width:100%;min-height:180px"></textarea>
        <div style="margin-top:10px">
          <button class="btn btn-primary" id="btnProcess">Processar</button>
          <span class="badge" id="statusBadge">Pronto</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="chead">
        <h2>Respostas</h2>
      </div>
      <div class="body">
        <p><b>Leve:</b> <span id="r1">‚Äî</span></p>
        <p><b>M√©dia:</b> <span id="r2">‚Äî</span></p>
        <p><b>Agressiva:</b> <span id="r3">‚Äî</span></p>
      </div>
    </section>

  </div>
</main>

<script>
/* ===================== CORE ===================== */
const LS_BASE = "copiloto_base_v3";
const LS_SESSION = "copiloto_session_v2";

/* ---------- HELPERS ---------- */
function normalize(v){
  return String(v||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
function parseNumber(v){
  if(v===null||v===undefined) return NaN;
  let s = String(v).replace("%","").trim();
  const hasComma = s.includes(",");
  const hasDot = s.includes(".");
  if(hasComma && hasDot){
    if(s.lastIndexOf(",") > s.lastIndexOf(".")){
      s = s.replace(/\./g,"").replace(",",".");
    }else{
      s = s.replace(/,/g,"");
    }
  }else if(hasComma){
    s = s.replace(",",".");
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function fmtBRL(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return "‚Äî";
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL",maximumFractionDigits:0});
}

/* ---------- BASE PADR√ÉO ---------- */
const DEFAULT_BASE = {
  users:[
    {username:"admin",password:"1234",role:"admin",name:"Administrador"},
    {username:"user",password:"1234",role:"user",name:"Corretor"}
  ],
  products:[],
  objections:[]
};

function loadBase(){
  try{
    const raw = localStorage.getItem(LS_BASE);
    return raw ? JSON.parse(raw) : structuredClone(DEFAULT_BASE);
  }catch{
    return structuredClone(DEFAULT_BASE);
  }
}
function saveBase(b){
  localStorage.setItem(LS_BASE, JSON.stringify(b,null,2));
}
let BASE = loadBase();

/* ---------- LOGIN ---------- */
let SESSION = null;
const overlay = document.getElementById("loginOverlay");

function showLogin(){ overlay.classList.add("show"); }
function hideLogin(){ overlay.classList.remove("show"); }

function authenticate(u,p){
  return BASE.users.find(x=>x.username===u && x.password===p) || null;
}

document.getElementById("btnLogin").onclick = ()=>{
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  const user = authenticate(u,p);
  if(!user){
    loginMsg.textContent = "Usu√°rio ou senha inv√°lidos";
    return;
  }
  SESSION = user;
  if(rememberSession.checked){
    localStorage.setItem(LS_SESSION, JSON.stringify(user));
  }
  hideLogin();
};

document.getElementById("btnLoginDemo").onclick = ()=>{
  SESSION = BASE.users.find(u=>u.role==="user");
  hideLogin();
};

document.getElementById("btnExit").onclick = ()=>{
  localStorage.removeItem(LS_SESSION);
  SESSION=null;
  showLogin();
};

/* ---------- THEME ---------- */
toggleTheme.onclick = ()=>{
  const t = document.body.getAttribute("data-theme")==="dark"?"light":"dark";
  document.body.setAttribute("data-theme",t);
  localStorage.setItem("copiloto_theme",t);
};

/* ---------- INIT ---------- */
(function init(){
  const saved = localStorage.getItem(LS_SESSION);
  if(saved){
    SESSION = JSON.parse(saved);
    hideLogin();
  }else{
    showLogin();
  }
})();
</script>

<!-- ===== CONTINUA NA PARTE 2 ===== -->

</body>
</html>
<!-- ===================== PARTE 2A (REESCRITA) ===================== -->
<script>
/* =========================================================
   ECONOMIA ‚Äî BCB/SGS (cache 6h)
========================================================= */
const LS_ECON = "copiloto_econ_cache_v4";
const ECON_TTL = 6*60*60*1000;
let ECON = { selicAA:null, ipca12:null, igpm12:null, updatedAt:null };

function econCache(){
  try{
    const raw = localStorage.getItem(LS_ECON);
    if(!raw) return null;
    const o = JSON.parse(raw);
    if(Date.now()-o.savedAt>ECON_TTL) return null;
    return o.data;
  }catch{ return null; }
}
function saveEcon(d){
  localStorage.setItem(LS_ECON, JSON.stringify({savedAt:Date.now(), data:d}));
}
async function fetchSGS(series, n){
  const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${series}/dados/ultimos/${n}?formato=json`;
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("BCB");
  return r.json();
}
function compounded12(arr){
  let a=1;
  arr.forEach(v=>{
    const n=parseNumber(v);
    if(Number.isFinite(n)) a*=(1+n/100);
  });
  return (a-1)*100;
}
async function loadEconomy(){
  const c = econCache();
  if(c){ ECON=c; return ECON; }
  try{
    const sel = await fetchSGS(432,1);
    const ip = await fetchSGS(433,12);
    const ig = await fetchSGS(189,12);
    ECON = {
      selicAA: parseNumber(sel?.[0]?.valor),
      ipca12: compounded12(ip.map(x=>x.valor)),
      igpm12: compounded12(ig.map(x=>x.valor)),
      updatedAt: new Date().toISOString()
    };
    saveEcon(ECON);
    return ECON;
  }catch{
    return ECON;
  }
}

/* =========================================================
   PRODUTOS ‚Äî LISTA + DETEC√á√ÉO
========================================================= */
let activeProduct = null;
const productBox = document.getElementById("productBox");

function renderProductList(){
  if(!BASE.products.length){
    productBox.innerHTML = `<div class="small">Nenhum produto cadastrado</div>`;
    return;
  }
  productBox.innerHTML = `
    <div class="small" style="margin-bottom:8px">Produtos dispon√≠veis:</div>
    ${BASE.products.map(p=>`
      <button class="btn" style="margin:4px 4px 0 0" onclick="selectProduct('${p.id}')">
        ${p.name}
      </button>`).join("")}
  `;
}
window.selectProduct = (id)=>{
  const p = BASE.products.find(x=>x.id===id);
  if(p) showProduct(p);
};

function detectProduct(text){
  const t = normalize(text);
  let best=null, score=0;
  BASE.products.forEach(p=>{
    const keys = [p.name,...(p.aliases||[])].map(normalize);
    let s=0;
    keys.forEach(k=>{ if(k && t.includes(k)) s+=k.length; });
    if(s>score){ score=s; best=p; }
  });
  return best;
}

/* =========================================================
   KPI ‚Äî CUSTO DE ESPERAR
========================================================= */
function effectiveMonthly(aa){
  const a = Number(aa);
  if(!Number.isFinite(a)) return NaN;
  return Math.pow(1+a/100,1/12)-1;
}
function calcLoss(value, annualPct, months){
  const v = Number(value);
  const aa = Number(annualPct);
  if(!Number.isFinite(v) || !Number.isFinite(aa)) return NaN;
  const m = effectiveMonthly(aa);
  return v * (Math.pow(1+m, months) - 1);
}

/* =========================================================
   PRODUTO ATIVO + VISUAL
========================================================= */
function showProduct(p){
  activeProduct = p;
  productBox.innerHTML = `
    <b>${p.name}</b>
    <div class="small">Valor: ${fmtBRL(p.value)}</div>
    <div class="small">Entrada: ${fmtBRL(p.entrada||0)}</div>
    <div class="small">Parcela: ${fmtBRL(p.parcela)}</div>
    <div class="small">Prazo: ${p.prazo||"‚Äî"}x</div>
    <div class="small">Reajuste: ${p.reajuste||"‚Äî"}</div>
  `;
  render12m();
  renderGraph();
  fillSimFromProduct();
}

/* =========================================================
   TABELA 12 MESES ‚Äî ENTRADA + PARCELAS
========================================================= */
function resolveReajAA(p){
  const r = String(p.reajuste||"").toUpperCase();
  if(r==="IPCA") return ECON.ipca12;
  if(r==="IGPM"||r==="IGP-M") return ECON.igpm12;
  if(r==="SELIC") return ECON.selicAA;
  const m=r.match(/([\d.,]+)/);
  return m?parseNumber(m[1]):null;
}
function render12m(){
  if(!activeProduct) return;
  loadEconomy().then(()=>{
    const p=activeProduct;
    const reajAA=resolveReajAA(p);
    const reajM=effectiveMonthly(reajAA);
    const valM=effectiveMonthly(p.valorizacaoAA||18);
    let html=`<table style="width:100%;font-size:12px"><tr><th>M√™s</th><th>Parcela</th><th>Valor lote</th><th>Saldo</th></tr>`;
    let invest = Number(p.entrada||0);
    for(let m=1;m<=12;m++){
      const par = Number.isFinite(reajM)? p.parcela*Math.pow(1+reajM,m):p.parcela;
      invest += par;
      const lot = Number.isFinite(valM)? p.value*Math.pow(1+valM,m):p.value;
      const saldo = lot-invest;
      html+=`<tr>
        <td>${m}</td>
        <td>${fmtBRL(par)}</td>
        <td>${fmtBRL(lot)}</td>
        <td style="font-weight:900;color:${saldo>=0?'green':'red'}">${fmtBRL(saldo)}</td>
      </tr>`;
    }
    html+=`</table>`;
    productBox.insertAdjacentHTML("beforeend", html);
  });
}

/* =========================================================
   GR√ÅFICO ‚Äî INVESTIDO x VALORIZADO
========================================================= */
const chart = document.createElement("canvas");
chart.width=600; chart.height=220;
productBox.appendChild(chart);

function renderGraph(){
  if(!activeProduct) return;
  const ctx=chart.getContext("2d");
  ctx.clearRect(0,0,chart.width,chart.height);
  const p=activeProduct;
  const valM=effectiveMonthly(p.valorizacaoAA||18);
  let invest=p.entrada||0;
  let inv=[], val=[];
  for(let i=1;i<=12;i++){
    invest+=p.parcela;
    inv.push(invest);
    val.push(p.value*Math.pow(1+valM,i));
  }
  const max=Math.max(...inv,...val)*1.1;
  const x=i=>40+i*(520/11);
  const y=v=>200-(v/max)*160;
  ctx.strokeStyle="#4f46e5"; ctx.beginPath();
  inv.forEach((v,i)=> i?ctx.lineTo(x(i),y(v)):ctx.moveTo(x(i),y(v))); ctx.stroke();
  ctx.strokeStyle="#22c55e"; ctx.beginPath();
  val.forEach((v,i)=> i?ctx.lineTo(x(i),y(v)):ctx.moveTo(x(i),y(v))); ctx.stroke();
}

/* =========================================================
   SIMULADOR ‚Äî PRICE SIMPLES (EDIT√ÅVEL)
========================================================= */
const simBox=document.createElement("div");
simBox.className="card";
simBox.innerHTML=`
  <div class="chead"><h2>üßÆ Simulador</h2></div>
  <div class="body">
    <input class="inp" id="simPV" placeholder="Valor do im√≥vel">
    <input class="inp" id="simEntrada" placeholder="Entrada">
    <input class="inp" id="simPMT" placeholder="Parcela desejada">
    <input class="inp" id="simN" placeholder="Prazo (meses)">
    <input class="inp" id="simI" placeholder="Taxa a.m. (%)" value="1,2">
    <div class="small" id="simOut">Simula√ß√£o estimada.</div>
  </div>`;
document.querySelector("main").appendChild(simBox);

function pricePMT(pv,i,n){
  if(i===0) return pv/n;
  const r=i/100;
  return pv*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
}
function pricePV(pmt,i,n){
  const r=i/100;
  return pmt*((Math.pow(1+r,n)-1)/(r*Math.pow(1+r,n)));
}
function fillSimFromProduct(){
  if(!activeProduct) return;
  simPV.value=activeProduct.value;
  simEntrada.value=activeProduct.entrada||0;
  simPMT.value=activeProduct.parcela;
  simN.value=activeProduct.prazo||180;
}
["simPV","simEntrada","simPMT","simN","simI"].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>{
    const PV=parseNumber(simPV.value);
    const E=parseNumber(simEntrada.value)||0;
    const PMT=parseNumber(simPMT.value);
    const n=parseNumber(simN.value);
    const i=parseNumber(simI.value);
    let out="Simula√ß√£o estimada.";
    if(Number.isFinite(PV)&&Number.isFinite(E)&&Number.isFinite(n)&&Number.isFinite(i)){
      const pmt=pricePMT(PV-E,i,n);
      out=`Parcela estimada: ${fmtBRL(pmt)}`;
    }else if(Number.isFinite(PV)&&Number.isFinite(PMT)&&Number.isFinite(n)&&Number.isFinite(i)){
      const fin=pricePV(PMT,i,n);
      out=`Entrada necess√°ria: ${fmtBRL(PV-fin)}`;
    }
    simOut.textContent=out;
  });
});

/* =========================================================
   PROCESSAMENTO (GANCHO PARA OBJE√á√ïES ‚Äî ENTRA NA 2B)
========================================================= */
btnProcess.onclick = ()=>{
  const t=inputText.value.trim();
  if(!t) return;
  const p=detectProduct(t);
  if(p) showProduct(p);

  // >>> AQUI a PARTE 2B vai plugar o motor de obje√ß√µes <<<
};
renderProductList();
</script>

<!-- ===== CONTINUA NA PARTE 2B (OBJE√á√ïES) ===== -->
<!-- ===================== PARTE 2B (OBJE√á√ïES) ===================== -->
<script>
/* =========================================================
   OBJE√á√ïES ‚Äî INVESTIDOR S√äNIOR (SEM JARG√ÉO) + TOM FIRME
   - 50 obje√ß√µes cl√°ssicas
   - leve / m√©dia / agressiva
   - agressiva usa n√∫meros (loss1/loss6) quando houver produto ativo
   - detec√ß√£o por ranking (melhor que "primeiro match")
========================================================= */

/* Se a base n√£o tiver obje√ß√µes, injeta o pacote padr√£o abaixo */
(function ensureObjectionsPack(){
  if(Array.isArray(BASE.objections) && BASE.objections.length >= 10) return;

  BASE.objections = [
    /* 1 */ { id:"pensar", keywords:["vou pensar","vou pensar melhor","pensar","depois","analisar","avaliar","ver com calma","mais pra frente"],
      leve:"Perfeito. Pensar faz parte. O que voc√™ quer analisar primeiro: valor, localiza√ß√£o ou condi√ß√£o?",
      media:"Pra eu te ajudar de verdade: o que precisa ficar claro pra voc√™ decidir sem d√∫vida?",
      agressiva:"Pensar √© inteligente. S√≥ n√£o congela o pre√ßo. Se voc√™ esperar, voc√™ aceita pagar mais depois ‚Äî ou quer travar o valor de hoje?"
    },
    /* 2 */ { id:"falar_esposa", keywords:["vou falar com minha esposa","vou falar com a esposa","preciso falar com minha esposa","vou ver com a patroa"],
      leve:"Claro. O que costuma pesar mais pra ela: seguran√ßa ou o valor mensal?",
      media:"Se voc√™ levar os n√∫meros certos, essa conversa vira objetiva. Quer que eu te organize isso em 30 segundos?",
      agressiva:"Quando a conversa √© s√≥ opini√£o, trava. Quando entra n√∫mero, anda. Voc√™ quer levar dado ou levar d√∫vida pra casa?"
    },
    /* 3 */ { id:"falar_marido", keywords:["vou falar com meu marido","vou falar com o marido","preciso falar com meu marido"],
      leve:"Tranquilo. Ele costuma olhar mais risco ou oportunidade?",
      media:"Se eu deixar isso bem claro pra voc√™ explicar, ajuda a decis√£o de voc√™s?",
      agressiva:"Decis√£o de casal n√£o trava por falta de vontade ‚Äî trava por falta de clareza. Vamos tirar a d√∫vida agora e voc√™ leva fechado."
    },
    /* 4 */ { id:"falar_socio", keywords:["vou falar com meu socio","vou falar com o s√≥cio","preciso falar com meu socio","meu socio decide","meu s√≥cio decide"],
      leve:"Perfeito. Seu s√≥cio √© mais conservador ou mais pr√°tico?",
      media:"Quer que eu te passe o resumo do que realmente importa, pra conversa com ele render?",
      agressiva:"S√≥cio bom decide com dado, n√£o com achismo. Voc√™ quer voltar com proposta ou voltar com ‚Äòvamos ver‚Äô?"
    },
    /* 5 */ { id:"falar_contador", keywords:["vou falar com o contador","contador","contabilidade","meu contador"],
      leve:"Perfeito. Ele vai olhar mais o impacto mensal ou a estrutura do neg√≥cio?",
      media:"Se voc√™ quiser, eu j√° te deixo isso claro pra voc√™ n√£o perder tempo na conversa.",
      agressiva:"Contador calcula. Quem decide √© voc√™. Se o n√∫mero fecha, o resto √© desculpa bonita pra adiar."
    },
    /* 6 */ { id:"caro", keywords:["caro","ta caro","t√° caro","muito caro","pesado","alto","fora do or√ßamento","n√£o cabe"],
      leve:"Entendi. Quando voc√™ diz caro, √© pela parcela ou pelo valor final?",
      media:"Se eu ajustar o cen√°rio pra ficar confort√°vel por m√™s, isso resolve?",
      agressiva:"Caro √© pagar mais depois. Hoje voc√™ compra com valor de hoje. Amanh√£ voc√™ compra com valor do mercado. Qual voc√™ prefere?"
    },
    /* 7 */ { id:"esperar_baixar", keywords:["vou esperar baixar","esperar baixar","quando baixar eu volto","vou esperar cair","esperar cair"],
      leve:"Justo. O que te faz acreditar que vai baixar?",
      media:"Se n√£o baixar e subir, voc√™ ficaria confort√°vel com essa escolha?",
      agressiva:"Esperar cair √© confort√°vel. Comprar bem √© lucrativo. Normalmente voc√™ n√£o consegue os dois ao mesmo tempo."
    },
    /* 8 */ { id:"nao_momento", keywords:["agora n√£o","n√£o √© o momento","n√£o √© agora","talvez mais pra frente","agora n√£o d√°"],
      leve:"Entendi. O que precisa acontecer pra virar ‚Äòagora sim‚Äô?",
      media:"Se eu resolver esse ponto hoje, voc√™ avan√ßa?",
      agressiva:"Momento perfeito n√£o aparece. Oportunidade aparece e some. Voc√™ quer decidir com calma ou com vantagem?"
    },
    /* 9 */ { id:"inseguranca", keywords:["n√£o estou seguro","n√£o tenho certeza","tenho receio","to com medo","t√¥ com medo","inseguro","p√© atr√°s"],
      leve:"Totalmente justo. √â inseguran√ßa de valor, de documento ou do cen√°rio?",
      media:"Se eu tirar essa d√∫vida agora com fatos, voc√™ segue?",
      agressiva:"Inseguran√ßa sem dado vira trava. Vamos colocar tudo na mesa e decidir como adulto: ou fecha ou descarta."
    },
    /* 10 */ { id:"trauma", keywords:["j√° perdi dinheiro","j√° levei preju√≠zo","j√° me lasquei","j√° me ferrei","j√° me arrependi antes"],
      leve:"Entendo. Foi problema do neg√≥cio ou do momento que voc√™ entrou?",
      media:"O que voc√™ faria diferente hoje pra n√£o repetir?",
      agressiva:"Quem nunca perdeu dinheiro nunca investiu de verdade. A diferen√ßa √© aprender e escolher melhor agora."
    },
    /* 11 */ { id:"nao_erro", keywords:["n√£o quero errar","medo de errar","n√£o quero fazer besteira","n√£o quero me arrepender"],
      leve:"O que seria ‚Äòerrar‚Äô pra voc√™: pagar caro, escolher mal ou entrar na hora errada?",
      media:"Se eu te der clareza total do que voc√™ est√° comprando, isso te libera pra decidir?",
      agressiva:"A maioria erra n√£o decidindo. E a√≠ compra atrasado. Quer errar parado ou errar andando com controle?"
    },
    /* 12 */ { id:"liquidez", keywords:["prefiro liquidez","quero liquidez","n√£o quero prender dinheiro","n√£o quero amarrar dinheiro"],
      leve:"Entendi. Voc√™ quer liquidez por seguran√ßa ou por oportunidade?",
      media:"Se voc√™ separar uma parte pra ficar livre e outra pra crescer, te atende?",
      agressiva:"Dinheiro 100% livre normalmente rende menos do que voc√™ imagina. Voc√™ quer liberdade total ou quer resultado?"
    },
    /* 13 */ { id:"dinheiro_parado", keywords:["deixar o dinheiro parado","deixar parado","deixar no banco","vou deixar rendendo","vou deixar no cdb","vou deixar na renda fixa"],
      leve:"Perfeito. Voc√™ quer tranquilidade ou crescimento?",
      media:"Voc√™ mede esse rendimento contra o aumento real dos pre√ßos?",
      agressiva:"Dinheiro parado perde valor em sil√™ncio. Voc√™ s√≥ percebe quando tenta comprar e v√™ que encurtou."
    },
    /* 14 */ { id:"comparar", keywords:["vou comparar","comparar com outro","vou ver outro","vou olhar outros","vou pesquisar"],
      leve:"Claro. Voc√™ vai comparar o qu√™: pre√ßo, localiza√ß√£o, condi√ß√£o ou potencial?",
      media:"Se esse continuar melhor no conjunto, voc√™ fica com ele?",
      agressiva:"Comparar √© inteligente. S√≥ n√£o use compara√ß√£o pra empurrar a decis√£o. Quer fechar com o melhor ou quer s√≥ ‚Äòolhar‚Äô?"
    },
    /* 15 */ { id:"nao_vejo_vantagem", keywords:["n√£o vejo vantagem","n√£o vi vantagem","n√£o achei vantagem","n√£o faz sentido"],
      leve:"O que voc√™ considera vantagem num neg√≥cio: pre√ßo, margem ou oportunidade?",
      media:"Se eu te mostrar onde est√° o ganho, voc√™ reavalia?",
      agressiva:"Se voc√™ s√≥ entra quando todo mundo v√™ vantagem, voc√™ entra tarde. Quer entrar antes ou depois?"
    },
    /* 16 */ { id:"nao_imobilizar", keywords:["n√£o quero imobilizar","n√£o quero imobilizar capital","n√£o quero prender dinheiro","n√£o quero travar capital"],
      leve:"Entendo. Voc√™ quer flexibilidade por medo ou por estrat√©gia?",
      media:"Se a condi√ß√£o te d√° respiro e ainda cresce, faz sentido?",
      agressiva:"Prender dinheiro √© ruim quando √© ruim. Quando √© bom, chama patrim√¥nio. Qual voc√™ est√° buscando?"
    },
    /* 17 */ { id:"muito_imovel", keywords:["j√° tenho im√≥vel","j√° tenho muito im√≥vel","j√° tenho bastante im√≥vel","j√° tenho terreno"],
      leve:"Entendi. Voc√™ sente excesso ou s√≥ est√° seletivo?",
      media:"Esse aqui √© igual aos seus ou √© um tipo diferente de oportunidade?",
      agressiva:"Problema n√£o √© ter muito im√≥vel. √â ter im√≥vel ruim. Se for bom, ele merece espa√ßo."
    },
    /* 18 */ { id:"nao_anima", keywords:["n√£o me anima","n√£o gostei","n√£o empolga","n√£o me chamou aten√ß√£o"],
      leve:"O que normalmente te chama aten√ß√£o num neg√≥cio?",
      media:"Se eu te mostrar o cen√°rio completo, muda a vis√£o?",
      agressiva:"Neg√≥cio bom nem sempre empolga. Ele protege e cresce. Empolga√ß√£o demais normalmente custa caro."
    },
    /* 19 */ { id:"prazo_longo", keywords:["prazo longo","muito tempo","muito longo","n√£o quero longo prazo","n√£o quero d√≠vida longa"],
      leve:"Voc√™ incomoda mais com o prazo ou com o valor mensal?",
      media:"Se o mensal ficar leve e voc√™ puder antecipar depois, resolve?",
      agressiva:"Prazo √© ferramenta, n√£o pris√£o. Pris√£o √© pagar caro por esperar."
    },
    /* 20 */ { id:"nao_sei_precisar", keywords:["posso precisar do dinheiro","n√£o sei se vou precisar","vai que eu preciso","se acontecer algo"],
      leve:"Justo. Existe chance real no curto prazo?",
      media:"Se precisar, seria tudo ou parte?",
      agressiva:"Manter tudo ‚Äòlivre‚Äô por medo trava crescimento. Se voc√™ separar uma reserva, o resto pode trabalhar por voc√™."
    },

    /* 21 */ { id:"sem_entrada", keywords:["n√£o tenho entrada","sem entrada","n√£o tenho sinal","n√£o tenho dinheiro de entrada","n√£o tenho pra entrada"],
      leve:"Entendi. Voc√™ prefere sem entrada ou uma entrada menor pra melhorar a condi√ß√£o?",
      media:"Se eu te mostrar um cen√°rio em que a entrada fica vi√°vel, voc√™ segue?",
      agressiva:"Entrada se ajusta. O que n√£o volta √© o tempo. Quer resolver entrada ou quer continuar pagando o pre√ßo de esperar?"
    },
    /* 22 */ { id:"parcela_pesada", keywords:["parcela pesada","parcela alta","presta√ß√£o alta","mensal pesado","n√£o cabe"],
      leve:"Qual valor mensal seria confort√°vel pra voc√™?",
      media:"Se eu ajustar prazo/entrada pra bater nesse valor, voc√™ fecha?",
      agressiva:"Se voc√™ j√° sabe quanto cabe, a gente s√≥ precisa montar o cen√°rio. O resto √© desculpa pra adiar."
    },
    /* 23 */ { id:"renda_baixa", keywords:["minha renda √© baixa","renda baixa","ganho pouco","minha renda n√£o d√°"],
      leve:"Qual valor mensal voc√™ paga sem apertar?",
      media:"Se eu colocar o n√∫mero dentro do seu limite, voc√™ avan√ßa?",
      agressiva:"Esperar renda subir costuma sair caro. Quem entra antes cresce junto com o patrim√¥nio."
    },
    /* 24 */ { id:"medo_banco", keywords:["banco","financiamento","n√£o confio em banco","banco enrola","banco nega"],
      leve:"Entendi. Seu medo √© reprovar ou √© a burocracia?",
      media:"Se eu te mostrar um caminho simples e realista, voc√™ tenta?",
      agressiva:"Burocracia n√£o √© motivo pra perder oportunidade. A oportunidade passa; o banco voc√™ resolve."
    },
    /* 25 */ { id:"nome_sujo", keywords:["nome sujo","restri√ß√£o","negativado","serasa","spc"],
      leve:"Entendi. Voc√™ est√° resolvendo isso ou est√° parado?",
      media:"Se a gente trabalhar um cen√°rio que n√£o dependa disso agora, ajuda?",
      agressiva:"Nome sujo n√£o √© senten√ßa. √â fase. O pior √© voc√™ deixar o tempo passar e pagar mais caro depois."
    },
    /* 26 */ { id:"score", keywords:["score baixo","score","meu score","pontua√ß√£o"],
      leve:"Voc√™ j√° sabe mais ou menos como est√° seu score hoje?",
      media:"Se o cen√°rio n√£o ficar dependente s√≥ disso, voc√™ avan√ßa?",
      agressiva:"Score muda com h√°bito. Pre√ßo muda com mercado. Qual voc√™ controla melhor hoje?"
    },
    /* 27 */ { id:"medo_economia", keywords:["economia","crise","t√° ruim","t√° dif√≠cil","incerteza","inst√°vel"],
      leve:"Entendi. O que te preocupa mais: renda ou pre√ßo?",
      media:"Se voc√™ travar um bom pre√ßo agora, isso te protege no cen√°rio ruim.",
      agressiva:"Crise √© quando os bons neg√≥cios aparecem. Em alta, todo mundo quer. Em d√∫vida, poucos fazem."
    },
    /* 28 */ { id:"politica", keywords:["elei√ß√£o","pol√≠tica","governo","mudan√ßa de governo","ano eleitoral"],
      leve:"Justo. Voc√™ acha que vai impactar mais juros ou confian√ßa?",
      media:"Se isso impactar, voc√™ acha que im√≥vel fica mais barato ou mais caro?",
      agressiva:"Quando o cen√°rio clareia, o pre√ßo j√° andou. Quem espera clarear normalmente compra caro."
    },
    /* 29 */ { id:"nao_quero_pressa", keywords:["n√£o gosto de pressa","n√£o me pressione","sem pressa","calma"],
      leve:"Tranquilo. Eu n√£o t√¥ te apressando. S√≥ quero clareza.",
      media:"Voc√™ quer calma pra decidir ou calma pra adiar?",
      agressiva:"Calma √© virtude. S√≥ n√£o confunda calma com travar. Travar custa dinheiro."
    },
    /* 30 */ { id:"preciso_ver_pessoalmente", keywords:["preciso ver","quero ver","ver pessoalmente","visitar","ir l√°"],
      leve:"Perfeito. O que voc√™ quer checar no local: acesso, vizinhan√ßa ou padr√£o?",
      media:"Se no local bater com o que eu te mostrei, voc√™ decide?",
      agressiva:"Visitar √© certo. S√≥ n√£o usa visita como desculpa pra adiar. Vamos marcar e j√° deixar o pr√≥ximo passo alinhado."
    },

    /* 31 */ { id:"localizacao", keywords:["localiza√ß√£o","onde fica","longe","n√£o gostei do lugar","n√£o √© boa regi√£o"],
      leve:"Entendi. O que pra voc√™ define uma boa regi√£o: acesso, com√©rcio ou valoriza√ß√£o?",
      media:"Se eu te mostrar o que est√° vindo pra essa regi√£o, muda sua leitura?",
      agressiva:"Boa regi√£o n√£o nasce pronta. Ela vira boa ‚Äî e quem entra antes compra mais barato."
    },
    /* 32 */ { id:"infra", keywords:["infraestrutura","asfalto","√°gua","esgoto","ilumina√ß√£o","obra","poeira"],
      leve:"Justo. Voc√™ quer saber o que j√° est√° pronto e o que est√° no cronograma, certo?",
      media:"Se eu te passar o cronograma real, voc√™ fica confort√°vel?",
      agressiva:"Infra √© tempo. E tempo √© dinheiro. Se voc√™ espera ficar 100% pronto, paga o pre√ßo do pronto."
    },
    /* 33 */ { id:"documentos", keywords:["documento","documenta√ß√£o","contrato","matr√≠cula","cart√≥rio","registro","escritura","golpe"],
      leve:"Perfeito. Quer que eu te mostre exatamente quais documentos a gente tem?",
      media:"Se estiver tudo regular, isso resolve seu receio?",
      agressiva:"Documento resolve com prova, n√£o com tempo. Se est√° regular, adiar n√£o protege ‚Äî s√≥ encarece."
    },
    /* 34 */ { id:"valorizar", keywords:["valoriza","vai valorizar","n√£o sei se valoriza","duvido que valorize"],
      leve:"Entendi. Voc√™ j√° viu essa regi√£o crescer antes?",
      media:"Se eu te mostrar hist√≥rico da regi√£o, voc√™ reavalia?",
      agressiva:"Quem espera certeza de valoriza√ß√£o compra depois da valoriza√ß√£o. A gra√ßa √© entrar antes."
    },
    /* 35 */ { id:"revenda", keywords:["revender","revenda","liquidez","vender r√°pido","se eu precisar vender"],
      leve:"Boa. Voc√™ pensa em prazo curto ou m√©dio?",
      media:"Se eu te mostrar o perfil de procura desse tipo de produto, ajuda?",
      agressiva:"Liquidez vem de compra bem-feita. Se voc√™ compra certo, sempre tem sa√≠da."
    },
    /* 36 */ { id:"aluguel", keywords:["pago aluguel","aluguel","prefiro alugar","moro de aluguel"],
      leve:"Entendi. Quanto voc√™ paga hoje?",
      media:"Se o que voc√™ paga fosse pra algo seu, muda o jogo?",
      agressiva:"Aluguel √© a parcela do patrim√¥nio de outra pessoa. Voc√™ quer continuar pagando o sonho dos outros?"
    },
    /* 37 */ { id:"prioridades", keywords:["outras prioridades","tenho prioridade","agora n√£o d√° por causa","estou apertado"],
      leve:"Entendi. O que est√° pesando mais hoje?",
      media:"Se eu encaixar sem te apertar, voc√™ avan√ßa?",
      agressiva:"Prioridade muda. Patrim√¥nio fica. Se voc√™ s√≥ compra quando sobra, voc√™ compra sempre caro."
    },
    /* 38 */ { id:"ja_investi", keywords:["j√° invisto","j√° tenho investimento","j√° tenho renda fixa","j√° tenho a√ß√µes","j√° tenho"],
      leve:"√ìtimo. Ent√£o voc√™ entende o jogo: entrar bem √© meio caminho.",
      media:"Esse aqui entra como prote√ß√£o ou como crescimento?",
      agressiva:"Voc√™ n√£o precisa de mais um investimento. Voc√™ precisa de um bom. Se √© bom, voc√™ age."
    },
    /* 39 */ { id:"nao_quero_compromisso", keywords:["n√£o quero compromisso","n√£o quero contrato","n√£o quero amarrar","n√£o quero obriga√ß√£o"],
      leve:"Entendi. √â medo de prazo ou medo de decis√£o?",
      media:"Se eu te mostrar um cen√°rio com sa√≠da e flexibilidade, resolve?",
      agressiva:"Evitar compromisso parece seguro. Mas normalmente √© o jeito mais caro de viver."
    },
    /* 40 */ { id:"medo_se_arrepender", keywords:["e se eu me arrepender","se eu me arrepender","arrependimento"],
      leve:"Justo. O que faria voc√™ se arrepender: pagar caro ou entrar num produto errado?",
      media:"Se eu te mostrar exatamente o que voc√™ est√° comprando, voc√™ fica confort√°vel?",
      agressiva:"Arrependimento maior √© assistir o pre√ßo subir e perceber que era sua chance."
    },

    /* 41 */ { id:"nao_quero_pressao", keywords:["n√£o quero press√£o","sem press√£o","n√£o me empurra","n√£o me empurre"],
      leve:"Tranquilo. Eu n√£o empurro. Eu organizo decis√£o.",
      media:"Se ficar claro, voc√™ decide com calma ‚Äî s√≥ com dire√ß√£o.",
      agressiva:"Press√£o ruim eu n√£o fa√ßo. Agora, decis√£o sem prazo vira decis√£o nunca."
    },
    /* 42 */ { id:"vou_sumir", keywords:["depois eu volto","depois te chamo","qualquer coisa eu falo","vou ver e te aviso"],
      leve:"Fechado. S√≥ me diz: voc√™ volta se for por pre√ßo ou por d√∫vida?",
      media:"Pra eu te ajudar, me fala qual ponto te trava hoje.",
      agressiva:"Se voc√™ some, voc√™ perde o timing. Me diz agora: √© ‚Äòn√£o‚Äô ou √© ‚Äòsim com condi√ß√£o‚Äô?"
    },
    /* 43 */ { id:"falta_dinheiro", keywords:["t√¥ sem dinheiro","sem grana","n√£o tenho dinheiro","apertado"],
      leve:"Entendi. Falta dinheiro agora ou falta previsibilidade mensal?",
      media:"Se eu montar um cen√°rio que n√£o te aperta, voc√™ considera?",
      agressiva:"Sem grana todo mundo fica em algum momento. O ponto √©: voc√™ quer usar isso como desculpa ou quer montar um plano real?"
    },
    /* 44 */ { id:"quero_desconto", keywords:["desconto","melhorar pre√ßo","abaixar","melhor pre√ßo","consegue melhorar"],
      leve:"Entendi. Voc√™ quer melhorar no valor ou na condi√ß√£o?",
      media:"Se eu conseguir melhorar a condi√ß√£o e te deixar mais confort√°vel, voc√™ fecha?",
      agressiva:"Desconto bom existe antes de todo mundo comprar. Depois que vende, n√£o tem conversa. Quer agir enquanto d√°?"
    },
    /* 45 */ { id:"nao_confio_corretor", keywords:["n√£o confio","j√° fui enganado","corretor","vendedor","vendas"],
      leve:"Entendo. Voc√™ n√£o precisa confiar em mim ‚Äî confie nos documentos e nos fatos.",
      media:"Se eu te mostrar tudo em prova, resolve?",
      agressiva:"Confian√ßa n√£o √© discurso. √â transpar√™ncia. Eu te dou prova. Se mesmo assim voc√™ n√£o decide, ent√£o n√£o √© sobre confian√ßa."
    },
    /* 46 */ { id:"medo_compra", keywords:["medo","receio","ansioso","tenso","inseguran√ßa de comprar"],
      leve:"Normal. Compra grande gera tens√£o mesmo.",
      media:"Se eu te deixar tudo claro e simples, melhora?",
      agressiva:"Voc√™ n√£o precisa ‚Äòcoragem‚Äô. Voc√™ precisa de clareza. Clareza a gente resolve agora."
    },
    /* 47 */ { id:"nao_entendo", keywords:["n√£o entendo","confuso","n√£o sei","n√£o sei como funciona","n√£o entendi"],
      leve:"Tranquilo. Eu explico simples, sem enrolar.",
      media:"Voc√™ prefere que eu mostre com n√∫meros ou com exemplos?",
      agressiva:"Se voc√™ n√£o entende, voc√™ adia. Se voc√™ adia, voc√™ paga mais. Vamos resolver isso r√°pido."
    },
    /* 48 */ { id:"quero_ver_papeis", keywords:["quero ver os pap√©is","quero ver papel","quero ver contrato","ver contrato","ver matr√≠cula"],
      leve:"Perfeito. Isso √© o certo a fazer.",
      media:"Se tudo estiver ok, voc√™ segue pro pr√≥ximo passo?",
      agressiva:"Se est√° tudo certo, adiar n√£o te protege. S√≥ te faz pagar o pre√ßo do tempo."
    },
    /* 49 */ { id:"sem_produto", keywords:["n√£o sei qual","qual produto","qual empreendimento","me mostra op√ß√µes","quais tem"],
      leve:"Fechado. Me diz s√≥: voc√™ quer mais ‚Äòbarato‚Äô, mais ‚Äòbem localizado‚Äô ou mais ‚Äòpotencial‚Äô?",
      media:"Se eu te mostrar 2 op√ß√µes bem diferentes, voc√™ escolhe uma pra gente aprofundar?",
      agressiva:"Op√ß√£o demais trava. Vamos escolher uma dire√ß√£o e decidir como investidor: objetivo primeiro, depois o produto."
    },
    /* 50 */ { id:"ultimo", keywords:["vou ver e retorno","vou ver depois","depois a gente conversa","mais pra frente eu vejo"],
      leve:"Perfeito. S√≥ me diz: voc√™ est√° travado por d√∫vida ou por dinheiro?",
      media:"Se eu resolver a d√∫vida, voc√™ volta com decis√£o?",
      agressiva:"Retornar sem prazo √© o jeito elegante de n√£o decidir. Me diz: voc√™ quer fechar quando ou voc√™ quer s√≥ deixar em aberto?"
    }
  ];

  try{ saveBase(BASE); }catch{}
})();

/* =========================================================
   DETEC√á√ÉO POR RANKING
========================================================= */
function detectObjectionRanked(text){
  const t = normalize(text);
  let best=null, bestScore=0;

  (BASE.objections||[]).forEach(obj=>{
    const keys = (obj.keywords||[]).map(normalize).filter(Boolean);
    let s=0;

    keys.forEach(k=>{
      if(!k) return;
      // score por "cont√©m"
      if(t.includes(k)) s += (k.length * 2);

      // b√¥nus por palavra inteira
      const safe = k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
      const re = new RegExp(`\\b${safe}\\b`, "g");
      const hits = (t.match(re) || []).length;
      if(hits) s += hits * 12;
    });

    if(s>bestScore){ bestScore=s; best=obj; }
  });

  return best;
}

/* =========================================================
   TEMPLATE + N√öMEROS (loss1/loss6) SEM JARG√ÉO
========================================================= */
function fillTemplate(str, data){
  return String(str||"")
    .replaceAll("{produto}", data.produto||"")
    .replaceAll("{loss1}", data.loss1||"‚Äî")
    .replaceAll("{loss6}", data.loss6||"‚Äî");
}

function buildInvestorData(){
  const hasProd = !!activeProduct;
  const produto = hasProd ? activeProduct.name : "";
  const value = hasProd ? Number(activeProduct.value) : NaN;
  const valAA = hasProd ? (activeProduct.valorizacaoAA ?? 18) : 18;

  const loss1n = hasProd ? calcLoss(value, valAA, 1) : NaN;
  const loss6n = hasProd ? calcLoss(value, valAA, 6) : NaN;

  return {
    produto,
    loss1: Number.isFinite(loss1n) ? fmtBRL(loss1n) : "‚Äî",
    loss6: Number.isFinite(loss6n) ? fmtBRL(loss6n) : "‚Äî"
  };
}

/* =========================================================
   APLICA√á√ÉO DAS RESPOSTAS (3 QUEBRAS)
========================================================= */
function applyInvestorObjections(text){
  const data = buildInvestorData();
  const obj = detectObjectionRanked(text);

  if(obj){
    // adiciona pitada ‚ÄúLobo‚Äù com n√∫meros quando houver produto
    const leve = fillTemplate(obj.leve, data);
    const media = fillTemplate(obj.media, data);

    let agressiva = fillTemplate(obj.agressiva, data);

    // refor√ßo num√©rico quando h√° produto ativo (sem jarg√£o)
    if(activeProduct){
      const extra = ` S√≥ pra voc√™ ter no√ß√£o: esperar 1 m√™s pode custar perto de ${data.loss1}. Em 6 meses, algo como ${data.loss6}.`;
      // n√£o repete se j√° tiver loss dentro do texto
      if(!agressiva.includes(data.loss1) && !agressiva.includes(data.loss6)){
        agressiva += extra;
      }
    }

    r1.textContent = leve;
    r2.textContent = media;
    r3.textContent = agressiva;
    statusBadge.textContent = `Obje√ß√£o: ${obj.id}`;
    return;
  }

  // fallback sem ‚Äúgen√©rico demais‚Äù e sem jarg√£o
  const base = buildInvestorData();
  r1.textContent = "Entendi. Me diz s√≥ uma coisa: o que hoje te trava mais ‚Äî pre√ßo, confian√ßa ou timing?";
  r2.textContent = "Se eu resolver esse ponto em 1 minuto, voc√™ decide com clareza?";
  r3.textContent = activeProduct
    ? `Direto: enquanto voc√™ adia, o pre√ßo anda. Pra ter refer√™ncia, 1 m√™s pode dar perto de ${base.loss1}. Quer travar o valor de hoje ou pagar o valor do tempo?`
    : "Direto: sem decidir, voc√™ s√≥ adia. Quer que eu te ajude a escolher uma dire√ß√£o e fechar isso com clareza?";
  statusBadge.textContent = "Obje√ß√£o: n√£o mapeada";
}

/* =========================================================
   PLUGA NO PROCESSAMENTO
========================================================= */
const _prevProcess = btnProcess.onclick;
btnProcess.onclick = ()=>{
  const t = inputText.value.trim();
  if(!t) return;

  const p = detectProduct(t);
  if(p) showProduct(p);

  applyInvestorObjections(t);
};

/* Bot√µes extras do header (placeholders por enquanto ‚Äî Parte 3 fecha) */
document.getElementById("btnSimulador").onclick = ()=>{
  // painel j√° est√° embaixo do main; aqui s√≥ faz scroll r√°pido
  simBox.scrollIntoView({behavior:"smooth", block:"start"});
};
document.getElementById("btnFormalizacao").onclick = ()=>{
  // Parte 3 implementa o envio real via localStorage + querystring
  alert("Formaliza√ß√£o ser√° conectada na Parte 3.");
};
</script>

<!-- ===== CONTINUA NA PARTE 3 ===== -->
<!-- ===================== PARTE 3 (FINAL) ===================== -->
<script>
/* =========================================================
   ADMIN ‚Äî ROBUSTEZ SEM FRAMEWORK
========================================================= */

const LS_BACKUP = "copiloto_base_backup_v1";

/* valida campos m√≠nimos */
function validateBaseStructure(b){
  if(!b || typeof b!=="object") return "Base inv√°lida";
  if(!Array.isArray(b.users)) return "users[] ausente";
  if(!Array.isArray(b.products)) return "products[] ausente";
  if(!Array.isArray(b.objections)) return "objections[] ausente";
  return null;
}

/* backup autom√°tico */
function backupBase(){
  try{
    localStorage.setItem(LS_BACKUP, JSON.stringify(BASE));
  }catch{}
}

/* restaura backup */
function restoreBackup(){
  try{
    const raw = localStorage.getItem(LS_BACKUP);
    if(!raw) return false;
    BASE = JSON.parse(raw);
    saveBase(BASE);
    return true;
  }catch{ return false; }
}

/* sobrescreve save do admin */
btnAdminSave.onclick = ()=>{
  try{
    const parsed = JSON.parse(adminJson.value);
    const err = validateBaseStructure(parsed);
    if(err){
      alert("Erro: "+err);
      return;
    }
    backupBase();
    BASE = parsed;
    saveBase(BASE);
    adminMsg.textContent = "‚úÖ Base salva com sucesso.";
    renderProductList();
    if(activeProduct){
      const p = BASE.products.find(x=>x.id===activeProduct.id);
      if(p) showProduct(p);
    }
  }catch{
    alert("JSON inv√°lido. Verifique a estrutura.");
  }
};

/* exporta√ß√£o */
btnAdminExport.onclick = ()=>{
  adminJson.value = JSON.stringify(BASE, null, 2);
  adminMsg.textContent = "‚úÖ JSON pronto para copiar.";
};
btnAdminCopy.onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(adminJson.value);
    adminMsg.textContent = "‚úÖ Copiado.";
  }catch{
    adminJson.select();
    document.execCommand("copy");
    adminMsg.textContent = "‚úÖ Copiado (fallback).";
  }
};

/* reset */
btnAdminReset.onclick = ()=>{
  if(!confirm("Resetar base padr√£o?")) return;
  BASE = structuredClone(DEFAULT_BASE);
  saveBase(BASE);
  adminJson.value = JSON.stringify(BASE, null, 2);
  adminMsg.textContent = "Base padr√£o restaurada.";
  renderProductList();
};

/* =========================================================
   FORMALIZA√á√ÉO DE PROPOSTA ‚Äî INTEGRA√á√ÉO
========================================================= */

function buildFormalizationPayload(){
  if(!activeProduct) return {};
  return {
    empreendimento: activeProduct.name || "",
    valor: activeProduct.value || "",
    entrada: activeProduct.entrada || "",
    parcela: activeProduct.parcela || "",
    prazo: activeProduct.prazo || "",
    reajuste: activeProduct.reajuste || "",
    timestamp: Date.now()
  };
}

function openFormalizacao(){
  const data = buildFormalizationPayload();
  localStorage.setItem("copiloto_formalizacao", JSON.stringify(data));

  const qs = new URLSearchParams({
    emp: data.empreendimento || "",
    valor: data.valor || "",
    entrada: data.entrada || "",
    parcela: data.parcela || "",
    prazo: data.prazo || ""
  }).toString();

  window.location.href =
    "https://lucianabogo333-spec.github.io/formalizacao-proposta/?" + qs;
}

/* bot√£o no header (se n√£o existir, cria) */
(function injectFormalButton(){
  if(document.getElementById("btnFormalizacao")) return;
  const btn = document.createElement("button");
  btn.id = "btnFormalizacao";
  btn.className = "btn btn-neon";
  btn.textContent = "üìÑ Formaliza√ß√£o de Proposta";
  btn.onclick = openFormalizacao;
  document.querySelector("header .top > div:last-child").prepend(btn);
})();

/* =========================================================
   LOGIN ‚Äî CONTROLE DE ACESSO
========================================================= */

function applyRoleUI(){
  if(!SESSION || SESSION.role!=="admin"){
    btnAdmin.disabled = true;
    btnAdmin.style.opacity = .5;
  }else{
    btnAdmin.disabled = false;
    btnAdmin.style.opacity = 1;
  }
}

/* =========================================================
   LISTA DE PRODUTOS SEMPRE VIS√çVEL
========================================================= */

(function ensureProductList(){
  if(!productBox) return;
  renderProductList();
})();

/* =========================================================
   INICIALIZA√á√ÉO FINAL
========================================================= */

(function finalize(){
  // tenta restaurar backup se base corrompida
  try{
    validateBaseStructure(BASE);
  }catch{
    if(restoreBackup()){
      console.warn("Base restaurada do backup.");
    }
  }
})();
</script>

<!-- ===================== FIM DO ARQUIVO ===================== -->
