<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COPILOTO PRO ‚Äî Fechamento Imobili√°rio</title>

<style>
/* ================== THEME ================== */
:root{
  --bg:#f5f7fb;
  --panel:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;

  --primary:#4f46e5;
  --primary-strong:#4338ca;

  --neon:#22c55e;
  --danger:#ef4444;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}

[data-theme="dark"]{
  --bg:#020617;
  --panel:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1e293b;
  --shadow:0 12px 40px rgba(0,0,0,.55);
}

/* ================== RESET ================== */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

/* ================== HEADER ================== */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
}
.top{
  max-width:1400px;
  margin:auto;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
}
.brand h1{
  margin:0;
  font-size:20px;
  font-weight:900;
}
.brand span{
  font-size:12px;
  color:var(--muted);
}

/* ================== BUTTONS ================== */
.btn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel);
  cursor:pointer;
  font-weight:800;
  transition:transform .06s ease, filter .15s ease;
}
.btn:active{transform:translateY(1px)}
.btn:hover{filter:brightness(0.98)}
.btn-primary{
  background:linear-gradient(180deg,var(--primary),var(--primary-strong));
  color:#fff;
  border:none;
}
.btn-neon{
  background:rgba(34,197,94,.15);
  color:var(--neon);
  border:1px solid rgba(34,197,94,.5);
  box-shadow:0 0 18px rgba(34,197,94,.35);
}
.btn-danger{
  background:rgba(239,68,68,.12);
  color:var(--danger);
  border:1px solid rgba(239,68,68,.4);
}
.btn-ghost{
  background:transparent;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.55);
}
[data-theme="dark"] .badge{ background:rgba(255,255,255,.04); }

/* ================== MAIN GRID ================== */
main{
  max-width:1400px;
  margin:auto;
  padding:24px;
}
.grid{
  display:grid;
  grid-template-columns:320px 1fr 420px;
  gap:20px;
}

/* ================== CARD ================== */
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card header{
  padding:16px;
  border-bottom:1px solid var(--border);
}
.card header h2{
  margin:0;
  font-size:15px;
}
.card header p{
  margin:6px 0 0;
  font-size:12px;
  color:var(--muted);
}
.card .body{
  padding:16px;
}

/* ================== PRODUCT ================== */
.product-name{
  font-size:18px;
  font-weight:900;
}
.product-meta{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.product-list{
  margin:14px 0 0;
  padding-left:18px;
}
.product-list li{
  font-size:13px;
  margin:6px 0;
}
.kpi{
  margin-top:14px;
  padding:12px;
  border:1px dashed var(--border);
  border-radius:14px;
  background:rgba(34,197,94,.06);
}
.kpi strong{display:block;font-size:12px}
.kpi span{display:block;margin-top:6px;font-size:14px;font-weight:900;color:var(--neon)}

/* ================== INPUT ================== */
textarea{
  width:100%;
  min-height:220px;
  padding:14px;
  font-size:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
  resize:vertical;
}
textarea:focus{
  outline:none;
  border-color:var(--primary);
}

/* ================== RESPONSES ================== */
.response{
  margin-bottom:14px;
}
.response strong{
  font-size:13px;
}
.response p{
  font-size:14px;
  line-height:1.55;
  margin:6px 0 0;
}

/* ================== RATES PANEL ================== */
.rates{
  display:none;
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(34,197,94,.35);
  background:rgba(34,197,94,.08);
}
.rates.show{display:block}
.rates-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.rate-item{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.55);
}
[data-theme="dark"] .rate-item{ background:rgba(255,255,255,.04); }
.rate-item .k{font-size:12px;color:var(--muted)}
.rate-item .v{margin-top:4px;font-size:16px;font-weight:1000;color:var(--text)}
.rate-foot{margin-top:10px;font-size:12px;color:var(--muted)}

/* ================== TABLE ================== */
.table-wrap{
  margin-top:14px;
  border-radius:14px;
  border:1px solid var(--border);
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  text-align:right;
  white-space:nowrap;
}
th:first-child, td:first-child{text-align:left}
thead th{
  position:sticky;
  top:0;
  background:var(--panel);
  z-index:1;
  font-size:12px;
}
tbody tr:hover{background:rgba(79,70,229,.05)}

/* ================== GRAPH ================== */
.graph-box{
  border-radius:14px;
  border:1px dashed var(--border);
  padding:10px;
  color:var(--muted);
}
.canvas-wrap{display:none}
.canvas-wrap.show{display:block}
canvas{
  width:100%;
  height:240px;
  border-radius:12px;
  background:rgba(255,255,255,.45);
}
[data-theme="dark"] canvas{ background:rgba(255,255,255,.05); }
.graph-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

/* ================== MODAL (ADMIN) ================== */
.modal{
  position:fixed; inset:0;
  display:none;
  background:rgba(0,0,0,.55);
  z-index:50;
  padding:18px;
}
.modal.show{display:flex;align-items:center;justify-content:center}
.modal-card{
  width:min(980px, 100%);
  max-height:90vh;
  overflow:hidden;
  border-radius:18px;
  background:var(--panel);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}
.modal-head{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.modal-head h3{margin:0;font-size:14px}
.modal-body{
  padding:14px 16px;
  overflow:auto;
  max-height:calc(90vh - 60px);
}
.field-row{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  margin-bottom:10px;
}
.small{
  font-size:12px;color:var(--muted);
}
.textbox{
  width:100%;
  min-height:260px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  resize:vertical;
}

/* ================== MOBILE ================== */
@media(max-width:1100px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body data-theme="light">

<header>
  <div class="top">
    <div class="brand">
      <h1>COPILOTO PRO</h1>
      <span>Fechamento imobili√°rio em tempo real</span>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-neon" id="btnRates">üìä Taxas</button>
      <button class="btn" id="btnAdmin">‚öôÔ∏è Admin</button>
      <button class="btn" id="toggleTheme">üåô / ‚òÄÔ∏è</button>
      <button class="btn btn-danger" id="btnExit">Sair</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- PRODUTO -->
    <aside class="card">
      <header>
        <h2>Produto ativo</h2>
        <p>Todas as informa√ß√µes do loteamento</p>
      </header>
      <div class="body">
        <div class="product-name" id="productName">Produto n√£o identificado</div>

        <div class="product-meta" id="productMeta"></div>

        <ul class="product-list" id="productInfo"></ul>

        <div class="kpi" id="kpiWait" style="display:none">
          <strong>‚è≥ Custo de esperar (estimativa)</strong>
          <span id="kpiWaitValue">‚Äî</span>
          <div class="small" id="kpiWaitHint"></div>
        </div>

        <div class="rates" id="ratesPanel">
          <div class="rates-grid">
            <div class="rate-item">
              <div class="k">SELIC (a.a.)</div>
              <div class="v" id="rateSelic">‚Äî</div>
            </div>
            <div class="rate-item">
              <div class="k">IPCA (12 meses)</div>
              <div class="v" id="rateIpca">‚Äî</div>
            </div>
            <div class="rate-item">
              <div class="k">IGP-M (12 meses)</div>
              <div class="v" id="rateIgpm">‚Äî</div>
            </div>
            <div class="rate-item">
              <div class="k">Cache</div>
              <div class="v" id="rateCache">‚Äî</div>
            </div>
          </div>
          <div class="rate-foot" id="ratesFoot">‚Äî</div>
        </div>

        <div id="tableBlock" style="display:none">
          <div class="small" style="margin-top:14px;font-weight:900;color:var(--text)">
            üìà Reajuste x Valoriza√ß√£o (12 meses)
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>M√™s</th>
                  <th>Parcela reajustada</th>
                  <th>Valor estimado do lote</th>
                  <th>Saldo</th>
                </tr>
              </thead>
              <tbody id="tbl12"></tbody>
            </table>
          </div>
          <div class="small" id="tblHint" style="margin-top:8px"></div>
        </div>

      </div>
    </aside>

    <!-- INPUT -->
    <section class="card">
      <header>
        <h2>Fala do cliente</h2>
        <p>Digite e pressione <b>Enter</b> para processar (Shift+Enter quebra linha) ou use o microfone</p>
      </header>
      <div class="body">
        <textarea id="inputText" placeholder="Digite ou dite o que o cliente falou..."></textarea>
        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btnMic">üéôÔ∏è Microfone</button>
          <button class="btn" id="btnProcess">‚ö° Processar</button>
          <button class="btn btn-danger" id="btnClear">Limpar</button>
          <span class="badge" id="statusBadge">Pronto</span>
        </div>
        <div class="small" style="margin-top:10px">
          Dica: fale ‚Äúcaro‚Äù, ‚Äúvou pensar‚Äù, ‚Äúdepois‚Äù, ‚Äúmedo‚Äù, ‚Äúentrada‚Äù, ‚Äúparcelas‚Äù etc.
        </div>
      </div>
    </section>

    <!-- RESPOSTAS + GR√ÅFICO -->
    <section>

      <div class="card">
        <header>
          <h2>Respostas sugeridas</h2>
          <p>Baseadas na obje√ß√£o detectada</p>
        </header>
        <div class="body">
          <div class="response">
            <strong>Leve</strong>
            <p id="r1">‚Äî</p>
          </div>
          <div class="response">
            <strong>M√©dia</strong>
            <p id="r2">‚Äî</p>
          </div>
          <div class="response">
            <strong>Agressiva</strong>
            <p id="r3">‚Äî</p>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <header>
          <h2>Valoriza√ß√£o do investimento</h2>
          <p>Visual para apresenta√ß√£o ao cliente</p>
        </header>
        <div class="body">
          <div class="graph-actions">
            <button class="btn btn-neon" id="btnGraphToggle">üìà Mostrar gr√°fico</button>
            <span class="badge" id="graphHint">Aparece quando houver produto ativo</span>
          </div>
          <div class="graph-box">
            <div class="canvas-wrap" id="canvasWrap">
              <canvas id="chart" width="900" height="300"></canvas>
              <div class="small" id="chartLegend" style="margin-top:8px"></div>
            </div>
            <div id="graphPlaceholder">Selecione um produto (digitando) para gerar o gr√°fico.</div>
          </div>
        </div>
      </div>

    </section>

  </div>
</main>

<!-- ADMIN MODAL -->
<div class="modal" id="adminModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h3>‚öôÔ∏è Admin ‚Äî Base (Produtos + Obje√ß√µes)</h3>
      <button class="btn btn-danger" id="btnAdminClose">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="field-row">
        <button class="btn btn-primary" id="btnAdminSave">Salvar Base</button>
        <button class="btn" id="btnAdminExport">Exportar JSON</button>
        <button class="btn" id="btnAdminCopy">Copiar</button>
        <button class="btn btn-danger" id="btnAdminReset">Reset padr√£o</button>
      </div>
      <div class="small" style="margin-bottom:10px">
        Exporta√ß√£o gera um JSON copi√°vel (para colar no GitHub). Importa√ß√£o: cole o JSON aqui e clique em <b>Salvar Base</b>.
      </div>
      <textarea class="textbox" id="adminJson" spellcheck="false"></textarea>
      <div class="small" id="adminMsg" style="margin-top:10px"></div>
    </div>
  </div>
</div>

</body>
</html>

<script>
/* =========================================================
   COPILOTO PRO ‚Äî Ajustes + Financeiro + Admin Base
   ========================================================= */

/* ===================== THEME ===================== */
const themeBtn = document.getElementById("toggleTheme");
const bodyEl = document.body;

const savedTheme = localStorage.getItem("copiloto_theme");
if(savedTheme) bodyEl.setAttribute("data-theme", savedTheme);

themeBtn.onclick = () => {
  const current = bodyEl.getAttribute("data-theme") || "light";
  const next = current === "light" ? "dark" : "light";
  bodyEl.setAttribute("data-theme", next);
  localStorage.setItem("copiloto_theme", next);
};

/* ===================== ELEMENTOS ===================== */
const productName = document.getElementById("productName");
const productInfo = document.getElementById("productInfo");
const productMeta = document.getElementById("productMeta");
const inputText = document.getElementById("inputText");

const r1 = document.getElementById("r1");
const r2 = document.getElementById("r2");
const r3 = document.getElementById("r3");

const ratesBtn = document.getElementById("btnRates");
const ratesPanel = document.getElementById("ratesPanel");
const rateSelic = document.getElementById("rateSelic");
const rateIpca = document.getElementById("rateIpca");
const rateIgpm = document.getElementById("rateIgpm");
const rateCache = document.getElementById("rateCache");
const ratesFoot = document.getElementById("ratesFoot");

const btnMic = document.getElementById("btnMic");
const btnClear = document.getElementById("btnClear");
const btnProcess = document.getElementById("btnProcess");
const statusBadge = document.getElementById("statusBadge");

const kpiWait = document.getElementById("kpiWait");
const kpiWaitValue = document.getElementById("kpiWaitValue");
const kpiWaitHint = document.getElementById("kpiWaitHint");

const tableBlock = document.getElementById("tableBlock");
const tbl12 = document.getElementById("tbl12");
const tblHint = document.getElementById("tblHint");

/* ===================== ESTADO ===================== */
let activeProduct = null;
let ECON = {
  selicAA: null, // anual
  ipca12: null,  // 12 meses (anual equivalente)
  igpm12: null,  // 12 meses (anual equivalente)
  updatedAt: null,
  source: "BCB/SGS"
};

/* ===================== HELPERS ===================== */
function brToNumber(v){
  if(v === null || v === undefined) return NaN;
  const s = String(v).trim().replace(/\./g, "").replace(",", ".");
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function fmtBRL(n){
  const x = Number(n);
  if(!Number.isFinite(x)) return "‚Äî";
  return x.toLocaleString("pt-BR", {style:"currency", currency:"BRL", maximumFractionDigits:0});
}
function fmtPct(n){
  const x = Number(n);
  if(!Number.isFinite(x)) return "‚Äî";
  return `${x.toFixed(2).replace(".", ",")}%`;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function nowISO(){ return new Date().toISOString(); }
function setStatus(text, kind=""){
  statusBadge.textContent = text;
  statusBadge.style.borderColor = kind==="good" ? "rgba(34,197,94,.55)" :
                                 kind==="warn" ? "rgba(245,158,11,.55)" :
                                 kind==="bad"  ? "rgba(239,68,68,.55)" : "";
}

/* ===================== BASE (LOCAL) ===================== */
const LS_KEY_BASE = "copiloto_base_v1";
const DEFAULT_BASE = {
  adminPin: "1234",
  products: [
    {
      id:"cedros",
      name:"CEDROS JARDINS",
      aliases:["cedros","cedros jardins","jardins"],
      value:150000,
      entrada:0,
      parcela:753,
      prazo:180,
      reajuste:"IPCA",     // "IPCA" | "IGPM" | "SELIC" | "12,5%"
      valorizacaoAA:18,
      info:[
        "Lotes a partir de 200 m¬≤",
        "Parcelas a partir de R$ 753",
        "Sem entrada",
        "Pr√≥ximo ao Posto B√∫falo"
      ]
    },
    {
      id:"morada",
      name:"MORADA BRASIL",
      aliases:["morada","morada brasil","andre maggi"],
      value:170000,
      entrada:0,
      parcela:713,
      prazo:240,
      reajuste:"IGPM",
      valorizacaoAA:18,
      info:[
        "Parcelas a partir de R$ 713",
        "At√© 240x",
        "Av. Andr√© Maggi"
      ]
    }
  ],
  objections: [
    {
      id:"pensar",
      keywords:["pensar","depois","analisar","ver com calma","mais pra frente"],
      leve:"Tudo bem analisar. O que voc√™ quer avaliar primeiro: localiza√ß√£o, condi√ß√£o ou parcela?",
      media:"S√≥ pra alinhar: o que precisa acontecer pra isso virar um ‚Äòsim‚Äô hoje?",
      agressiva:"Entendo. S√≥ que esperar normalmente sai mais caro: em 6 meses voc√™ pode perder cerca de {loss6}. Quer garantir no pre√ßo de agora ou pagar mais depois?"
    },
    {
      id:"caro",
      keywords:["caro","muito","pesado","n√£o cabe","alto","fora do or√ßamento"],
      leve:"Entendo. Quando voc√™ diz ‚Äòcaro‚Äô, √© pela parcela ou pelo valor final?",
      media:"Se eu ajustar prazo/entrada pra encaixar, voc√™ avan√ßa hoje? O que seria confort√°vel por m√™s?",
      agressiva:"O caro de verdade √© esperar: a valoriza√ß√£o corre todo m√™s. Voc√™ prefere pagar {loss1}/m√™s a mais no futuro ou travar a condi√ß√£o agora?"
    },
    {
      id:"medo",
      keywords:["medo","inseguro","receio","n√£o confio","golpe","garantia"],
      leve:"Totalmente justo. O que te deixaria seguro: contrato, matr√≠cula, hist√≥rico do loteamento?",
      media:"Se eu te mostrar documenta√ß√£o e cronograma, isso resolve sua inseguran√ßa?",
      agressiva:"Se a documenta√ß√£o estiver 100%, n√£o faz sentido adiar: voc√™ s√≥ compra mais caro depois. Vamos validar agora e travar a condi√ß√£o?"
    }
  ]
};

function loadBase(){
  try{
    const raw = localStorage.getItem(LS_KEY_BASE);
    if(!raw) return structuredClone(DEFAULT_BASE);
    const parsed = JSON.parse(raw);
    // fallback m√≠nimo
    if(!parsed.products || !Array.isArray(parsed.products)) parsed.products = structuredClone(DEFAULT_BASE.products);
    if(!parsed.objections || !Array.isArray(parsed.objections)) parsed.objections = structuredClone(DEFAULT_BASE.objections);
    if(!parsed.adminPin) parsed.adminPin = DEFAULT_BASE.adminPin;
    return parsed;
  }catch{
    return structuredClone(DEFAULT_BASE);
  }
}
function saveBase(base){
  localStorage.setItem(LS_KEY_BASE, JSON.stringify(base, null, 2));
}
let BASE = loadBase();
<script>
/* ===================== ECONOMIA (BCB/SGS) + CACHE 6H ===================== */
const LS_KEY_ECON = "copiloto_econ_cache_v1";
const ECON_TTL_MS = 6 * 60 * 60 * 1000;

async function fetchSGS(series, lastN){
  const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${series}/dados/ultimos/${lastN}?formato=json`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("Falha BCB/SGS");
  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

function compounded12m(monthlyArray){
  // monthlyArray: [%] m√™s a m√™s
  // retorna taxa 12 meses composta
  let acc = 1;
  for(const v of monthlyArray){
    const n = Number(v);
    if(!Number.isFinite(n)) continue;
    acc *= (1 + n/100);
  }
  return (acc - 1) * 100;
}

function effectiveMonthlyFromAnnual(annualPct){
  const a = Number(annualPct);
  if(!Number.isFinite(a)) return NaN;
  return Math.pow(1 + a/100, 1/12) - 1;
}

function econFromCache(){
  try{
    const raw = localStorage.getItem(LS_KEY_ECON);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.savedAt || !obj.data) return null;
    const age = Date.now() - obj.savedAt;
    if(age > ECON_TTL_MS) return null;
    return obj.data;
  }catch{
    return null;
  }
}

function saveEconCache(data){
  localStorage.setItem(LS_KEY_ECON, JSON.stringify({
    savedAt: Date.now(),
    data
  }));
}

async function loadEconomy(force=false){
  const cached = !force ? econFromCache() : null;
  if(cached){
    ECON = cached;
    updateRatesUI("cache");
    return ECON;
  }

  setStatus("Carregando taxas‚Ä¶", "warn");
  try{
    // SELIC: usar Meta Selic (432) e pegar o √∫ltimo valor (a.a.)
    const selicArr = await fetchSGS(432, 1);
    const selicAA = selicArr.length ? brToNumber(selicArr[0].valor) : NaN;

    // IPCA mensal (433) e IGP-M mensal (189) ‚Äî pegar √∫ltimos 12 e compor
    const ipcaArr = await fetchSGS(433, 12);
    const igpmArr = await fetchSGS(189, 12);

    const ipcaMonthly = ipcaArr.map(x => brToNumber(x.valor)).filter(Number.isFinite);
    const igpmMonthly = igpmArr.map(x => brToNumber(x.valor)).filter(Number.isFinite);

    const ipca12 = compounded12m(ipcaMonthly);
    const igpm12 = compounded12m(igpmMonthly);

    ECON = {
      selicAA,
      ipca12,
      igpm12,
      updatedAt: nowISO(),
      source: "BCB/SGS (432/433/189)"
    };

    saveEconCache(ECON);
    updateRatesUI("live");
    setStatus("Pronto", "good");
    return ECON;
  }catch(e){
    updateRatesUI("erro");
    setStatus("Sem taxas (offline)", "bad");
    return ECON;
  }
}

function updateRatesUI(mode){
  rateSelic.textContent = ECON.selicAA!=null ? fmtPct(ECON.selicAA) : "‚Äî";
  rateIpca.textContent  = ECON.ipca12!=null  ? fmtPct(ECON.ipca12)  : "‚Äî";
  rateIgpm.textContent  = ECON.igpm12!=null  ? fmtPct(ECON.igpm12)  : "‚Äî";

  const cache = econFromCache();
  if(cache){
    const raw = JSON.parse(localStorage.getItem(LS_KEY_ECON) || "{}");
    const ageMs = raw.savedAt ? (Date.now() - raw.savedAt) : null;
    const ageMin = ageMs!=null ? Math.round(ageMs/60000) : null;
    rateCache.textContent = ageMin!=null ? `${ageMin} min` : "‚Äî";
  }else{
    rateCache.textContent = "‚Äî";
  }

  const when = ECON.updatedAt ? new Date(ECON.updatedAt).toLocaleString("pt-BR") : "‚Äî";
  ratesFoot.textContent = `Fonte: ${ECON.source} ‚Ä¢ Atualizado: ${when} ‚Ä¢ Modo: ${mode}`;
}

/* painel econ√¥mico recolh√≠vel */
ratesBtn.onclick = async () => {
  const willShow = !ratesPanel.classList.contains("show");
  if(willShow){
    ratesPanel.classList.add("show");
    await loadEconomy(false);
  }else{
    ratesPanel.classList.remove("show");
  }
};

/* ===================== DETECTAR PRODUTO ===================== */
function normalize(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function detectProduct(text){
  const t = normalize(text);
  let best = null;
  let bestScore = 0;

  for(const p of BASE.products){
    const aliases = [p.name, ...(p.aliases||[])].map(normalize);
    for(const a of aliases){
      if(!a) continue;
      if(t.includes(a)){
        const score = a.length;
        if(score > bestScore){ bestScore = score; best = p; }
      }
    }
  }
  return best;
}

function showProduct(p){
  activeProduct = p;

  productName.textContent = p.name;

  // meta badges
  const reaj = String(p.reajuste||"‚Äî");
  productMeta.innerHTML = `
    <span class="badge">üí∞ Valor: <b>${fmtBRL(p.value)}</b></span>
    <span class="badge">üßæ Parcela: <b>${fmtBRL(p.parcela)}</b></span>
    <span class="badge">üïí Prazo: <b>${p.prazo || "‚Äî"}x</b></span>
    <span class="badge">üìå Reajuste: <b>${reaj}</b></span>
    <span class="badge">üìà Valoriza√ß√£o: <b>${fmtPct(p.valorizacaoAA)}</b></span>
  `;

  // infos completas (sem cortar)
  productInfo.innerHTML = (p.info||[]).map(i=>`<li>${i}</li>`).join("");

  // custo de esperar (1 m√™s)
  const loss1 = calcLoss(p.value, p.valorizacaoAA, 1);
  kpiWait.style.display = "block";
  kpiWaitValue.textContent = `${fmtBRL(loss1)} / m√™s`;
  kpiWaitHint.textContent = `Estimativa usando ${fmtPct(p.valorizacaoAA)} a.a. (Sinop-MT).`;

  // tabela 12 meses + gr√°fico
  build12MonthTable();
  renderGraph();
  updateGraphVisibilityHints();
}

/* ===================== CALCULADORA PERDA (valoriza√ß√£o) ===================== */
function calcLoss(value, rateAA, months){
  const monthly = effectiveMonthlyFromAnnual(rateAA);
  if(!Number.isFinite(monthly)) return NaN;
  const v0 = Number(value);
  return v0 * (Math.pow(1+monthly, months) - 1);
}

/* ===================== REAJUSTE (produto) ===================== */
function resolveReajusteAnnualPct(prod){
  // Se for IPCA/IGPM/SELIC => pega anual atual (12m para IPCA/IGPM; a.a. para SELIC)
  const r = String(prod.reajuste||"").trim().toUpperCase();
  if(r === "IPCA") return ECON.ipca12;
  if(r === "IGPM" || r === "IGP-M") return ECON.igpm12;
  if(r === "SELIC") return ECON.selicAA;

  // manual: "12,5%" ou "12.5"
  const m = r.match(/([\d.,]+)\s*%?/);
  if(m){
    const n = brToNumber(m[1]);
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

/* ===================== TABELA 12 MESES ===================== */
async function build12MonthTable(){
  if(!activeProduct) return;

  // garante economia carregada (sem travar)
  if(ECON.selicAA==null || ECON.ipca12==null || ECON.igpm12==null){
    await loadEconomy(false);
  }

  const parcela0 = Number(activeProduct.parcela);
  const valor0   = Number(activeProduct.value);
  const valAA    = Number(activeProduct.valorizacaoAA);

  const reajAA = resolveReajusteAnnualPct(activeProduct);
  const reajM = effectiveMonthlyFromAnnual(reajAA);

  const valM = effectiveMonthlyFromAnnual(valAA);

  const hasReaj = Number.isFinite(reajM);
  const hasVal  = Number.isFinite(valM);

  tbl12.innerHTML = "";
  let sumPaid = 0;

  for(let m=1; m<=12; m++){
    const parcelaM = hasReaj ? parcela0 * Math.pow(1+reajM, m) : parcela0;
    sumPaid += parcelaM;

    const loteM = hasVal ? valor0 * Math.pow(1+valM, m) : valor0;
    const saldo = loteM - sumPaid;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m}</td>
      <td>${fmtBRL(parcelaM)}</td>
      <td>${fmtBRL(loteM)}</td>
      <td style="font-weight:900;color:${saldo>=0 ? "var(--neon)" : "var(--danger)"}">${fmtBRL(saldo)}</td>
    `;
    tbl12.appendChild(tr);
  }

  tableBlock.style.display = "block";
  const reajLabel = (String(activeProduct.reajuste||"‚Äî") || "‚Äî");
  tblHint.textContent = `Reajuste usado: ${reajLabel} ‚Ä¢ Taxa anual considerada: ${Number.isFinite(reajAA) ? fmtPct(reajAA) : "‚Äî"} ‚Ä¢ Valoriza√ß√£o: ${fmtPct(activeProduct.valorizacaoAA)} a.a.`;
}

/* ===================== OBJE√á√ïES ===================== */
function detectObjection(text){
  const t = normalize(text);
  for(const obj of BASE.objections){
    const keys = (obj.keywords||[]).map(normalize);
    if(keys.some(k => k && t.includes(k))) return obj;
  }
  return null;
}

function fillTemplate(str, data){
  return String(str||"")
    .replaceAll("{produto}", data.produto||"")
    .replaceAll("{loss1}", data.loss1||"")
    .replaceAll("{loss6}", data.loss6||"");
}

async function processText(){
  const raw = inputText.value;
  const text = raw.trim();
  if(!text){
    setStatus("Digite algo‚Ä¶", "warn");
    return;
  }

  setStatus("Processando‚Ä¶", "warn");

  // produto
  const prod = detectProduct(text);
  if(prod) showProduct(prod);

  if(!activeProduct){
    r1.textContent = "Diga o nome do loteamento ou um ponto de refer√™ncia (ex: Posto B√∫falo).";
    r2.textContent = "Se voc√™ me disser o que o cliente falou, eu te dou 3 respostas prontas.";
    r3.textContent = "Me diga o produto (ex: CEDROS) pra eu usar n√∫meros e valoriza√ß√£o.";
    setStatus("Sem produto", "warn");
    return;
  }

  // economia (pra reajuste)
  await loadEconomy(false);

  // custo de esperar
  const loss1n = calcLoss(activeProduct.value, activeProduct.valorizacaoAA, 1);
  const loss6n = calcLoss(activeProduct.value, activeProduct.valorizacaoAA, 6);

  const data = {
    produto: activeProduct.name,
    loss1: fmtBRL(loss1n),
    loss6: fmtBRL(loss6n)
  };

  // obje√ß√£o
  const obj = detectObjection(text);

  if(obj){
    r1.textContent = fillTemplate(obj.leve, data);
    r2.textContent = fillTemplate(obj.media, data);
    r3.textContent = fillTemplate(obj.agressiva, data);
    setStatus(`Obje√ß√£o: ${obj.id}`, "good");
  }else{
    // fallback (gen√©rico bom)
    r1.textContent = "Entendi. Me diz: o que mais pesa pra voc√™ ‚Äî parcela, prazo ou localiza√ß√£o?";
    r2.textContent = "Se eu encaixar no que voc√™ quer por m√™s, voc√™ avan√ßa hoje?";
    r3.textContent = `S√≥ um ponto direto: cada m√™s que passa voc√™ pode perder cerca de ${data.loss1} em valoriza√ß√£o. Quer que eu te mostre a melhor condi√ß√£o agora?`;
    setStatus("Obje√ß√£o: gen√©rica", "good");
  }

  // atualizar tabela/gr√°fico
  build12MonthTable();
  renderGraph();
}

/* ===================== INPUT: S√ì PROCESSAR NO ENTER ===================== */
inputText.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    processText();
  }
});
btnProcess.onclick = () => processText();

btnClear.onclick = () => {
  inputText.value = "";
  setStatus("Pronto");
};

/* ===================== SAIR (limpa sess√£o local) ===================== */
document.getElementById("btnExit").onclick = () => {
  // aqui voc√™ decide se quer limpar base/theme/econ, ou s√≥ ‚Äúresetar tela‚Äù
  activeProduct = null;
  productName.textContent = "Produto n√£o identificado";
  productMeta.innerHTML = "";
  productInfo.innerHTML = "";
  kpiWait.style.display = "none";
  tableBlock.style.display = "none";
  r1.textContent = r2.textContent = r3.textContent = "‚Äî";
  document.getElementById("graphPlaceholder").style.display = "block";
  document.getElementById("canvasWrap").classList.remove("show");
  setStatus("Pronto");
};

/* ===================== MICROFONE (Web Speech API) ===================== */
let recognition = null;
let listening = false;

function setupSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const rec = new SR();
  rec.lang = "pt-BR";
  rec.interimResults = false;    // n√£o processa antes do fim da fala
  rec.continuous = false;        // encerra sozinho ao terminar
  return rec;
}

recognition = setupSpeech();

btnMic.onclick = () => {
  if(!recognition){
    setStatus("Microfone n√£o suportado", "bad");
    alert("Seu navegador n√£o suporta SpeechRecognition. Use Chrome/Edge no desktop ou digite.");
    return;
  }

  if(listening){
    recognition.stop();
    return;
  }

  try{
    listening = true;
    btnMic.textContent = "üõë Parar";
    setStatus("Ouvindo‚Ä¶", "warn");
    recognition.start();
  }catch(e){
    // start pode falhar se j√° estiver ativo
    setStatus("Microfone indispon√≠vel", "bad");
  }
};

if(recognition){
  recognition.onresult = (event) => {
    const t = event.results?.[0]?.[0]?.transcript || "";
    // adiciona no textarea e processa AP√ìS final da fala
    inputText.value = (inputText.value ? (inputText.value + "\n") : "") + t;
  };
  recognition.onend = () => {
    listening = false;
    btnMic.textContent = "üéôÔ∏è Microfone";
    setStatus("Processando √°udio‚Ä¶", "warn");
    // processa s√≥ ao final do √°udio
    processText().finally(()=> setStatus("Pronto", "good"));
  };
  recognition.onerror = () => {
    listening = false;
    btnMic.textContent = "üéôÔ∏è Microfone";
    setStatus("Erro no microfone", "bad");
  };
}
<script>
/* ===================== GR√ÅFICO CANVAS ===================== */
const btnGraphToggle = document.getElementById("btnGraphToggle");
const canvasWrap = document.getElementById("canvasWrap");
const graphPlaceholder = document.getElementById("graphPlaceholder");
const chart = document.getElementById("chart");
const chartLegend = document.getElementById("chartLegend");
const graphHint = document.getElementById("graphHint");

let graphVisible = false;

function updateGraphVisibilityHints(){
  if(activeProduct){
    graphHint.textContent = `Produto ativo: ${activeProduct.name}`;
  }else{
    graphHint.textContent = "Aparece quando houver produto ativo";
  }
}

btnGraphToggle.onclick = () => {
  graphVisible = !graphVisible;
  if(graphVisible){
    canvasWrap.classList.add("show");
    graphPlaceholder.style.display = "none";
    btnGraphToggle.textContent = "üìâ Esconder gr√°fico";
    renderGraph();
  }else{
    canvasWrap.classList.remove("show");
    graphPlaceholder.style.display = "block";
    btnGraphToggle.textContent = "üìà Mostrar gr√°fico";
  }
};

function renderGraph(){
  if(!activeProduct) return;
  if(!graphVisible) return;

  const ctx = chart.getContext("2d");
  const W = chart.width, H = chart.height;

  // s√©rie de 12 meses
  const months = 12;
  const val0 = Number(activeProduct.value);
  const parcela0 = Number(activeProduct.parcela);

  // valoriza√ß√£o e reajuste
  const valM = effectiveMonthlyFromAnnual(activeProduct.valorizacaoAA);

  const reajAA = resolveReajusteAnnualPct(activeProduct);
  const reajM = effectiveMonthlyFromAnnual(reajAA);

  // dados
  let invested = [];
  let valued = [];
  let sum = 0;

  for(let m=1; m<=months; m++){
    const par = Number.isFinite(reajM) ? parcela0 * Math.pow(1+reajM, m) : parcela0;
    sum += par;
    invested.push(sum);

    const vv = Number.isFinite(valM) ? val0 * Math.pow(1+valM, m) : val0;
    valued.push(vv);
  }

  const maxY = Math.max(...invested, ...valued) * 1.08;
  const minY = 0;

  function x(i){ return 48 + (i/(months-1))*(W-68); }
  function y(v){ return (H-34) - ((v-minY)/(maxY-minY))*(H-54); }

  // limpar
  ctx.clearRect(0,0,W,H);

  // eixos
  ctx.globalAlpha = 1;
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(120,120,120,.35)";
  ctx.beginPath();
  ctx.moveTo(42, 16);
  ctx.lineTo(42, H-28);
  ctx.lineTo(W-14, H-28);
  ctx.stroke();

  // grid horizontal
  for(let g=1; g<=4; g++){
    const yy = 16 + g*((H-44)/5);
    ctx.strokeStyle = "rgba(120,120,120,.18)";
    ctx.beginPath();
    ctx.moveTo(42, yy);
    ctx.lineTo(W-14, yy);
    ctx.stroke();
  }

  // linha 1 (investido) ‚Äî roxo
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(79,70,229,.95)";
  ctx.beginPath();
  invested.forEach((v,i)=>{
    const xx = x(i), yy = y(v);
    if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // linha 2 (lote valorizado) ‚Äî verde neon
  ctx.strokeStyle = "rgba(34,197,94,.95)";
  ctx.beginPath();
  valued.forEach((v,i)=>{
    const xx = x(i), yy = y(v);
    if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // pontos finais
  const lastInv = invested[invested.length-1];
  const lastVal = valued[valued.length-1];

  ctx.fillStyle = "rgba(79,70,229,1)";
  ctx.beginPath(); ctx.arc(x(months-1), y(lastInv), 5, 0, Math.PI*2); ctx.fill();

  ctx.fillStyle = "rgba(34,197,94,1)";
  ctx.beginPath(); ctx.arc(x(months-1), y(lastVal), 5, 0, Math.PI*2); ctx.fill();

  // labels simples
  ctx.fillStyle = "rgba(120,120,120,.9)";
  ctx.font = "12px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("M√™s", W-40, H-10);
  ctx.fillText("R$", 18, 24);

  chartLegend.textContent =
    `Roxo = valor investido (parcelas acumuladas) ‚Ä¢ Verde = lote valorizado ‚Ä¢ 12 meses ‚Ä¢ Reajuste: ${
      String(activeProduct.reajuste||"‚Äî")
    } ‚Ä¢ Valoriza√ß√£o: ${fmtPct(activeProduct.valorizacaoAA)} a.a.`;
}

/* ===================== ADMIN (PIN + EXPORT/IMPORT) ===================== */
const adminModal = document.getElementById("adminModal");
const btnAdmin = document.getElementById("btnAdmin");
const btnAdminClose = document.getElementById("btnAdminClose");
const adminJson = document.getElementById("adminJson");
const adminMsg = document.getElementById("adminMsg");

const btnAdminSave = document.getElementById("btnAdminSave");
const btnAdminExport = document.getElementById("btnAdminExport");
const btnAdminCopy = document.getElementById("btnAdminCopy");
const btnAdminReset = document.getElementById("btnAdminReset");

function openAdmin(){
  adminJson.value = JSON.stringify(BASE, null, 2);
  adminMsg.textContent = "Dica: edite com cuidado. Ex.: products[], objections[].";
  adminModal.classList.add("show");
  adminModal.setAttribute("aria-hidden","false");
}
function closeAdmin(){
  adminModal.classList.remove("show");
  adminModal.setAttribute("aria-hidden","true");
}
btnAdminClose.onclick = closeAdmin;

btnAdmin.onclick = () => {
  const pin = prompt("PIN Admin:");
  if(pin === null) return;
  if(String(pin).trim() !== String(BASE.adminPin).trim()){
    alert("PIN incorreto.");
    return;
  }
  openAdmin();
};

btnAdminSave.onclick = () => {
  try{
    const parsed = JSON.parse(adminJson.value);
    if(!parsed || !Array.isArray(parsed.products) || !Array.isArray(parsed.objections)){
      alert("JSON inv√°lido: precisa conter products[] e objections[].");
      return;
    }
    BASE = parsed;
    saveBase(BASE);
    adminMsg.textContent = "‚úÖ Base salva no dispositivo (localStorage).";
    setStatus("Base atualizada", "good");

    // se produto ativo foi editado, recarrega UI
    if(activeProduct){
      const refreshed = BASE.products.find(p => p.id === activeProduct.id) || null;
      if(refreshed) showProduct(refreshed);
    }
  }catch(e){
    alert("Erro ao salvar JSON. Verifique v√≠rgulas/aspas.");
  }
};

btnAdminExport.onclick = () => {
  // export j√° est√° no textarea, mas garantimos formata√ß√£o
  adminJson.value = JSON.stringify(BASE, null, 2);
  adminMsg.textContent = "‚úÖ JSON gerado. Use Copiar e cole no GitHub.";
};

btnAdminCopy.onclick = async () => {
  try{
    await navigator.clipboard.writeText(adminJson.value);
    adminMsg.textContent = "‚úÖ Copiado para a √°rea de transfer√™ncia.";
  }catch{
    // fallback
    adminJson.select();
    document.execCommand("copy");
    adminMsg.textContent = "‚úÖ Copiado (fallback).";
  }
};

btnAdminReset.onclick = () => {
  if(!confirm("Resetar para base padr√£o? Isso substitui sua base atual.")) return;
  BASE = structuredClone(DEFAULT_BASE);
  saveBase(BASE);
  adminJson.value = JSON.stringify(BASE, null, 2);
  adminMsg.textContent = "‚úÖ Base padr√£o restaurada.";
  setStatus("Base resetada", "warn");
};

/* fechar modal ao clicar fora */
adminModal.addEventListener("click", (e) => {
  if(e.target === adminModal) closeAdmin();
});

/* ===================== INIT ===================== */
(async function init(){
  setStatus("Pronto");
  updateGraphVisibilityHints();
  // pr√©-carrega economia em cache se quiser (n√£o trava)
  // await loadEconomy(false);
})();
</script>
